define(["exports","./when-45f3d25d","./Check-34538dad","./Cartesian3-e69091b9","./Cartesian2-7a44370a","./BoundingSphere-e9924a3b","./Matrix4-c65e6a1b","./Rectangle-c7d55cfa","./ComponentDatatype-86703c58","./AttributeCompression-1e177d5e"],(function(e,t,i,r,a,n,o,s,c,m){"use strict";function u(e,a){i.Check.typeOf.object("ellipsoid",e),this._ellipsoid=e,this._cameraPosition=new r.Cartesian3,this._cameraPositionInScaledSpace=new r.Cartesian3,this._distanceToLimbInScaledSpaceSquared=0,t.defined(a)&&(this.cameraPosition=a)}Object.defineProperties(u.prototype,{ellipsoid:{get:function(){return this._ellipsoid}},cameraPosition:{get:function(){return this._cameraPosition},set:function(e){var t=this._ellipsoid,i=t.transformPositionToScaledSpace(e,this._cameraPositionInScaledSpace),a=r.Cartesian3.magnitudeSquared(i)-1;r.Cartesian3.clone(e,this._cameraPosition),this._cameraPositionInScaledSpace=i,this._distanceToLimbInScaledSpaceSquared=a}}});var d=new r.Cartesian3;u.prototype.isPointVisible=function(e){var t=this._ellipsoid,i=t.transformPositionToScaledSpace(e,d);return b(i,this._cameraPositionInScaledSpace,this._distanceToLimbInScaledSpaceSquared)},u.prototype.isScaledSpacePointVisible=function(e){return b(e,this._cameraPositionInScaledSpace,this._distanceToLimbInScaledSpaceSquared)};var l=new r.Cartesian3;u.prototype.isScaledSpacePointVisiblePossiblyUnderEllipsoid=function(e,i){var r,a,n=this._ellipsoid;return t.defined(i)&&i<0&&n.minimumRadius>-i?(a=l,a.x=this._cameraPosition.x/(n.radii.x+i),a.y=this._cameraPosition.y/(n.radii.y+i),a.z=this._cameraPosition.z/(n.radii.z+i),r=a.x*a.x+a.y*a.y+a.z*a.z-1):(a=this._cameraPositionInScaledSpace,r=this._distanceToLimbInScaledSpaceSquared),b(e,a,r)},u.prototype.computeHorizonCullingPoint=function(e,t,i){return x(this._ellipsoid,e,t,i)};var p=a.Ellipsoid.clone(a.Ellipsoid.UNIT_SPHERE);u.prototype.computeHorizonCullingPointPossiblyUnderEllipsoid=function(e,t,i,r){var a=C(this._ellipsoid,i,p);return x(a,e,t,r)},u.prototype.computeHorizonCullingPointFromVertices=function(e,t,i,r,a){return S(this._ellipsoid,e,t,i,r,a)},u.prototype.computeHorizonCullingPointFromVerticesPossiblyUnderEllipsoid=function(e,t,i,r,a,n){var o=C(this._ellipsoid,a,p);return S(o,e,t,i,r,n)};var h=[];u.prototype.computeHorizonCullingPointFromRectangle=function(e,t,a){i.Check.typeOf.object("rectangle",e);var o=s.Rectangle.subsample(e,t,0,h),c=n.BoundingSphere.fromPoints(o);if(!(r.Cartesian3.magnitude(c.center)<.1*t.minimumRadius))return this.computeHorizonCullingPoint(c.center,o,a)};var f=new r.Cartesian3;function C(e,i,n){if(t.defined(i)&&i<0&&e.minimumRadius>-i){var o=r.Cartesian3.fromElements(e.radii.x+i,e.radii.y+i,e.radii.z+i,f);e=a.Ellipsoid.fromCartesian3(o,n)}return e}function x(e,a,n,o){i.Check.typeOf.object("directionToPoint",a),i.Check.defined("positions",n),t.defined(o)||(o=new r.Cartesian3);for(var s=z(e,a),c=0,m=0,u=n.length;m<u;++m){var d=n[m],l=M(e,d,s);if(l<0)return;c=Math.max(c,l)}return T(s,c,o)}var y=new r.Cartesian3;function S(e,a,n,o,s,c){i.Check.typeOf.object("directionToPoint",a),i.Check.defined("vertices",n),i.Check.typeOf.number("stride",o),t.defined(c)||(c=new r.Cartesian3),o=t.defaultValue(o,3),s=t.defaultValue(s,r.Cartesian3.ZERO);for(var m=z(e,a),u=0,d=0,l=n.length;d<l;d+=o){y.x=n[d]+s.x,y.y=n[d+1]+s.y,y.z=n[d+2]+s.z;var p=M(e,y,m);if(p<0)return;u=Math.max(u,p)}return T(m,u,c)}function b(e,t,i){var a=t,n=i,o=r.Cartesian3.subtract(e,a,d),s=-r.Cartesian3.dot(o,a),c=n<0?s>0:s>n&&s*s/r.Cartesian3.magnitudeSquared(o)>n;return!c}var v=new r.Cartesian3,g=new r.Cartesian3;function M(e,t,i){var a=e.transformPositionToScaledSpace(t,v),n=r.Cartesian3.magnitudeSquared(a),o=Math.sqrt(n),s=r.Cartesian3.divideByScalar(a,o,g);n=Math.max(1,n),o=Math.max(1,o);var c=r.Cartesian3.dot(s,i),m=r.Cartesian3.magnitude(r.Cartesian3.cross(s,i,s)),u=1/o,d=Math.sqrt(n-1)*u;return 1/(c*u-m*d)}function T(e,t,i){if(!(t<=0||t===1/0||t!==t))return r.Cartesian3.multiplyByScalar(e,t,i)}var P=new r.Cartesian3;function z(e,t){return r.Cartesian3.equals(t,r.Cartesian3.ZERO)?t:(e.transformPositionToScaledSpace(t,P),r.Cartesian3.normalize(P,P))}var E={NONE:0,BITS12:1},N=Object.freeze(E),I=new r.Cartesian3,B=new r.Cartesian3,_=new a.Cartesian2,w=new o.Matrix4,A=new o.Matrix4,q=Math.pow(2,12);function H(e,i,a,n,s,c){var m,u,d,l=N.NONE;if(t.defined(e)&&t.defined(i)&&t.defined(a)&&t.defined(n)){var p=e.minimum,h=e.maximum,f=r.Cartesian3.subtract(h,p,B),C=a-i,x=Math.max(r.Cartesian3.maximumComponent(f),C);l=x<q-1?N.BITS12:N.NONE,m=e.center,u=o.Matrix4.inverseTransformation(n,new o.Matrix4);var y=r.Cartesian3.negate(p,I);o.Matrix4.multiply(o.Matrix4.fromTranslation(y,w),u,u);var S=I;S.x=1/f.x,S.y=1/f.y,S.z=1/f.z,o.Matrix4.multiply(o.Matrix4.fromScale(S,w),u,u),d=o.Matrix4.clone(n),o.Matrix4.setTranslation(d,r.Cartesian3.ZERO,d),n=o.Matrix4.clone(n,new o.Matrix4);var b=o.Matrix4.fromTranslation(p,w),v=o.Matrix4.fromScale(f,A),g=o.Matrix4.multiply(b,v,w);o.Matrix4.multiply(n,g,n),o.Matrix4.multiply(d,g,d)}this.quantization=l,this.minimumHeight=i,this.maximumHeight=a,this.center=m,this.toScaledENU=u,this.fromScaledENU=n,this.matrix=d,this.hasVertexNormals=s,this.hasWebMercatorT=t.defaultValue(c,!1)}H.prototype.encode=function(e,t,i,n,s,c,u){var d=n.x,l=n.y;if(this.quantization===N.BITS12){i=o.Matrix4.multiplyByPoint(this.toScaledENU,i,I),i.x=r.CesiumMath.clamp(i.x,0,1),i.y=r.CesiumMath.clamp(i.y,0,1),i.z=r.CesiumMath.clamp(i.z,0,1);var p=this.maximumHeight-this.minimumHeight,h=r.CesiumMath.clamp((s-this.minimumHeight)/p,0,1);a.Cartesian2.fromElements(i.x,i.y,_);var f=m.AttributeCompression.compressTextureCoordinates(_);a.Cartesian2.fromElements(i.z,h,_);var C=m.AttributeCompression.compressTextureCoordinates(_);a.Cartesian2.fromElements(d,l,_);var x=m.AttributeCompression.compressTextureCoordinates(_);if(e[t++]=f,e[t++]=C,e[t++]=x,this.hasWebMercatorT){a.Cartesian2.fromElements(u,0,_);var y=m.AttributeCompression.compressTextureCoordinates(_);e[t++]=y}}else r.Cartesian3.subtract(i,this.center,I),e[t++]=I.x,e[t++]=I.y,e[t++]=I.z,e[t++]=s,e[t++]=d,e[t++]=l,this.hasWebMercatorT&&(e[t++]=u);return this.hasVertexNormals&&(e[t++]=m.AttributeCompression.octPackFloat(c)),t},H.prototype.decodePosition=function(e,i,a){if(t.defined(a)||(a=new r.Cartesian3),i*=this.getStride(),this.quantization===N.BITS12){var n=m.AttributeCompression.decompressTextureCoordinates(e[i],_);a.x=n.x,a.y=n.y;var s=m.AttributeCompression.decompressTextureCoordinates(e[i+1],_);return a.z=s.x,o.Matrix4.multiplyByPoint(this.fromScaledENU,a,a)}return a.x=e[i],a.y=e[i+1],a.z=e[i+2],r.Cartesian3.add(a,this.center,a)},H.prototype.decodeTextureCoordinates=function(e,i,r){return t.defined(r)||(r=new a.Cartesian2),i*=this.getStride(),this.quantization===N.BITS12?m.AttributeCompression.decompressTextureCoordinates(e[i+2],r):a.Cartesian2.fromElements(e[i+4],e[i+5],r)},H.prototype.decodeHeight=function(e,t){if(t*=this.getStride(),this.quantization===N.BITS12){var i=m.AttributeCompression.decompressTextureCoordinates(e[t+1],_);return i.y*(this.maximumHeight-this.minimumHeight)+this.minimumHeight}return e[t+3]},H.prototype.decodeWebMercatorT=function(e,t){return t*=this.getStride(),this.quantization===N.BITS12?m.AttributeCompression.decompressTextureCoordinates(e[t+3],_).x:e[t+6]},H.prototype.getOctEncodedNormal=function(e,t,i){var r=this.getStride();t=(t+1)*r-1;var n=e[t]/256,o=Math.floor(n),s=256*(n-o);return a.Cartesian2.fromElements(o,s,i)},H.prototype.getStride=function(){var e;switch(this.quantization){case N.BITS12:e=3;break;default:e=6}return this.hasWebMercatorT&&++e,this.hasVertexNormals&&++e,e};var O={position3DAndHeight:0,textureCoordAndEncodedNormals:1},V={compressed0:0,compressed1:1};H.prototype.getAttributes=function(e){var t,i=c.ComponentDatatype.FLOAT,r=c.ComponentDatatype.getSizeInBytes(i);if(this.quantization===N.NONE){var a=4,n=2;return this.hasWebMercatorT&&++n,this.hasVertexNormals&&++n,t=(a+n)*r,[{index:O.position3DAndHeight,vertexBuffer:e,componentDatatype:i,componentsPerAttribute:a,offsetInBytes:0,strideInBytes:t},{index:O.textureCoordAndEncodedNormals,vertexBuffer:e,componentDatatype:i,componentsPerAttribute:n,offsetInBytes:a*r,strideInBytes:t}]}var o=3,s=0;return(this.hasWebMercatorT||this.hasVertexNormals)&&++o,this.hasWebMercatorT&&this.hasVertexNormals?(++s,t=(o+s)*r,[{index:V.compressed0,vertexBuffer:e,componentDatatype:i,componentsPerAttribute:o,offsetInBytes:0,strideInBytes:t},{index:V.compressed1,vertexBuffer:e,componentDatatype:i,componentsPerAttribute:s,offsetInBytes:o*r,strideInBytes:t}]):[{index:V.compressed0,vertexBuffer:e,componentDatatype:i,componentsPerAttribute:o}]},H.prototype.getAttributeLocations=function(){return this.quantization===N.NONE?O:V},H.clone=function(e,i){return t.defined(i)||(i=new H),i.quantization=e.quantization,i.minimumHeight=e.minimumHeight,i.maximumHeight=e.maximumHeight,i.center=r.Cartesian3.clone(e.center),i.toScaledENU=o.Matrix4.clone(e.toScaledENU),i.fromScaledENU=o.Matrix4.clone(e.fromScaledENU),i.matrix=o.Matrix4.clone(e.matrix),i.hasVertexNormals=e.hasVertexNormals,i.hasWebMercatorT=e.hasWebMercatorT,i},e.EllipsoidalOccluder=u,e.TerrainEncoding=H}));