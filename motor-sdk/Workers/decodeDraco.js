define(["./when-45f3d25d","./Check-34538dad","./Cartesian3-e69091b9","./Cartesian2-7a44370a","./Matrix4-c65e6a1b","./RuntimeError-86da6af2","./WebGLConstants-3660bc8f","./ComponentDatatype-86703c58","./PrimitiveType-30fa6f85","./Transforms-68229cf3","./IndexDatatype-e52361bd","./createTaskProcessorWorker","./CreatePhysicalArray-d462d0a0","./materem-f017d2c3","./EmWrapperManager-a482472d","./EmLBDeal-6bed9fb9"],(function(r,e,t,a,n,o,i,d,I,y,s,u,f,c,A,m){"use strict";var l,p,T,b={DRACO_COMPRESSION:0,MATER_COMPRESSION:1,PROJECTIVE_TRANSFORM:2,POINT_CLOUD:3},N=Object.freeze(b);function w(r,e){for(var t=r.num_points(),a=r.num_faces(),n=new l.DracoInt32Array,o=3*a,i=s.IndexDatatype.createTypedArray(t,o),d=0,I=0;I<a;++I)e.GetFaceFromMesh(r,I,n),i[d+0]=n.GetValue(0),i[d+1]=n.GetValue(1),i[d+2]=n.GetValue(2),d+=3;return l.destroy(n),{typedArray:i,numberOfIndices:o}}function v(r,e,t,a,n){var o,i;a.quantizationBits<=8?(i=new l.DracoUInt8Array,o=new Uint8Array(n),e.GetAttributeUInt8ForAllPoints(r,t,i)):(i=new l.DracoUInt16Array,o=new Uint16Array(n),e.GetAttributeUInt16ForAllPoints(r,t,i));for(var d=0;d<n;++d)o[d]=i.GetValue(d);return l.destroy(i),o}function O(r,e,t,a){var n,o;switch(t.data_type()){case 1:case 11:o=new l.DracoInt8Array,n=new Int8Array(a),e.GetAttributeInt8ForAllPoints(r,t,o);break;case 2:o=new l.DracoUInt8Array,n=new Uint8Array(a),e.GetAttributeUInt8ForAllPoints(r,t,o);break;case 3:o=new l.DracoInt16Array,n=new Int16Array(a),e.GetAttributeInt16ForAllPoints(r,t,o);break;case 4:o=new l.DracoUInt16Array,n=new Uint16Array(a),e.GetAttributeUInt16ForAllPoints(r,t,o);break;case 5:case 7:o=new l.DracoInt32Array,n=new Int32Array(a),e.GetAttributeInt32ForAllPoints(r,t,o);break;case 6:case 8:o=new l.DracoUInt32Array,n=new Uint32Array(a),e.GetAttributeUInt32ForAllPoints(r,t,o);break;case 9:case 10:o=new l.DracoFloat32Array,n=new Float32Array(a),e.GetAttributeFloatForAllPoints(r,t,o);break}for(var i=0;i<a;++i)n[i]=o.GetValue(i);return l.destroy(o),n}function P(e,t,a){var n,o=e.num_points(),i=a.num_components(),I=new l.AttributeQuantizationTransform;if(I.InitFromAttribute(a)){for(var y=new Array(i),s=0;s<i;++s)y[s]=I.min_value(s);n={quantizationBits:I.quantization_bits(),minValues:y,range:I.range(),octEncoded:!1}}l.destroy(I),I=new l.AttributeOctahedronTransform,I.InitFromAttribute(a)&&(n={quantizationBits:I.quantization_bits(),octEncoded:!0}),l.destroy(I);var u,f=o*i;u=r.defined(n)?v(e,t,a,n,f):O(e,t,a,f);var c=d.ComponentDatatype.fromTypedArray(u);return{array:u,data:{componentsPerAttribute:i,componentDatatype:c,byteOffset:a.byte_offset(),byteStride:d.ComponentDatatype.getSizeInBytes(c)*i,normalized:a.normalized(),quantization:n}}}function C(r){var e=new l.Decoder;r.dequantizeInShader&&(e.SkipAttributeTransform(l.POSITION),e.SkipAttributeTransform(l.NORMAL));var t=new l.DecoderBuffer;t.Init(r.buffer,r.buffer.length);var a=e.GetEncodedGeometryType(t);if(a!==l.POINT_CLOUD)throw new o.RuntimeError("Draco geometry type must be POINT_CLOUD.");var n=new l.PointCloud,i=e.DecodeBufferToPointCloud(t,n);if(!i.ok()||0===n.ptr)throw new o.RuntimeError("Error decoding draco point cloud: "+i.error_msg());l.destroy(t);var d={},I=r.properties;for(var y in I)if(I.hasOwnProperty(y)){var s=I[y],u=e.GetAttributeByUniqueId(n,s);d[y]=P(n,e,u)}return l.destroy(n),l.destroy(e),d}function E(e){var a=new l.Decoder,i=["POSITION","NORMAL","COLOR","TEX_COORD"];if(e.dequantizeInShader)for(var d=0;d<i.length;++d)a.SkipAttributeTransform(l[i[d]]);var I=e.bufferView,y=new l.DecoderBuffer;y.Init(e.array,I.byteLength);var s=a.GetEncodedGeometryType(y);if(s!==l.TRIANGULAR_MESH)throw new o.RuntimeError("Unsupported draco mesh geometry type.");var u=new l.Mesh,c=a.DecodeBufferToMesh(y,u);if(!c.ok()||0===u.ptr)throw new o.RuntimeError("Error decoding draco mesh geometry: "+c.error_msg());l.destroy(y);var A={},b=[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY],N=[Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY],v=e.compressedAttributes;for(var O in v)if(v.hasOwnProperty(O)){var C=v[O],E=a.GetAttributeByUniqueId(u,C);if(A[O]=P(u,a,E),"POSITION"===O&&(e.projected||e.absPlaned)&&!e.isInstance){var D=e.isYUp,F=e.projectionString,G=e.dCenX,_=e.dCenY,S=e.dCenZ,h=new m.EmLBDeal,M=h.init(F,new t.Cartesian3(G,_,S));if(M){var V=A[O].array,g=e.matrix;e.projected?h.computeProjToCartesianAry(V,D,n.Matrix4.fromArray(g)):h.computeCartesianToProjAry(V,D,n.Matrix4.fromArray(g));for(var U=new Float32Array(V.length),R=0;R<V.length;++R)U[R]=V[R],b[R%3]>U[R]&&(b[R%3]=U[R]),N[R%3]<U[R]&&(N[R%3]=U[R]);A[O].array=U}h.destroy()}}var B,L=w(u,a),Y=r.defined(A["POSITION"])?A["POSITION"].array:void 0,x=r.defined(A["_BATCHID"])?A["_BATCHID"].array:void 0,k=L.typedArray,z=f.CreatePhysicalArray.createPhysicalArrayFromModel(p,T,e.primitiveMode,Y,x,k,B);A["_PHYSICAL"]={array:z};var j={indexArray:L,attributeData:A,min:b,max:N};return l.destroy(u),l.destroy(a),j}function D(r,e){var a={};if(r.projected){var o=r.isYUp,i=r.projectionString,d=r.dCenX,I=r.dCenY,y=r.dCenZ,s=new m.EmLBDeal,u=s.init(i,new t.Cartesian3(d,I,y));if(u){var f=new Float32Array(r.array.buffer,0),c=r.matrix;s.computeProjToCartesianAry(f,o,n.Matrix4.fromArray(c));for(var A=new Float32Array(f.length),l=0;l<f.length;++l)A[l]=f[l];a={attributeData:A},e.push(A.buffer)}s.destroy()}return a}function F(r,e,t){var a=d.ComponentDatatype.fromTypedArray(r);return{array:r,data:{componentsPerAttribute:e,componentDatatype:a,byteOffset:0,byteStride:d.ComponentDatatype.getSizeInBytes(a)*e,normalized:t,quantization:void 0}}}function G(e){var a=e.bufferView,i=new p.MaterPrimitiveDecoder;if(!i.Decode(e.array,a.byteLength))throw p.destroy(i),new o.RuntimeError("error mater compress.");for(var d,I=i.GetPtNum(),y=i.GetIndexNum(),u=s.IndexDatatype.createTypedArray(I,y),c=0;c<y;++c)u[c]=i.GetIndex(c);if(i.IsHaveEdgeCheck())for(d=new Int8Array(y),c=0;c<y;++c)d[c]=i.GetEdgeCheck(c);var A={},l=[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY],b=[Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY],N=new Float32Array(3*I);for(c=0;c<I;++c)N[3*c]=i.GetPtVal(c,0),N[3*c+1]=i.GetPtVal(c,1),N[3*c+2]=i.GetPtVal(c,2);if(A["POSITION"]=F(N,3,!1),(e.projected||e.absPlaned)&&!e.isInstance){var w=e.isYUp,v=e.projectionString,O=e.dCenX,P=e.dCenY,C=e.dCenZ,E=new m.EmLBDeal,D=E.init(v,new t.Cartesian3(O,P,C));if(D){var G=A["POSITION"].array,_=e.matrix;e.projected?E.computeProjToCartesianAry(G,w,n.Matrix4.fromArray(_)):E.computeCartesianToProjAry(G,w,n.Matrix4.fromArray(_));for(var S=new Float32Array(G.length),h=0;h<G.length;++h)S[h]=G[h],l[h%3]>S[h]&&(l[h%3]=S[h]),b[h%3]<S[h]&&(b[h%3]=S[h]);A["POSITION"].array=S}E.destroy()}if(i.IsHaveUV()){var M=new Float32Array(2*I);for(c=0;c<I;++c)M[2*c]=i.GetUVVal(c,0),M[2*c+1]=i.GetUVVal(c,1);A["TEXCOORD_0"]=F(M,2,!1)}if(i.IsHaveNormal()){var V=new Float32Array(3*I);for(c=0;c<I;++c)V[3*c]=i.GetNormalVal(c,0),V[3*c+1]=i.GetNormalVal(c,1),V[3*c+2]=i.GetNormalVal(c,2);A["NORMAL"]=F(V,3,!0)}if(i.IsHaveBatchId()){var g=new Float32Array(I);for(c=0;c<I;++c)g[c]=i.GetBatchId(c);A["_BATCHID"]=F(g,1,!1)}if(i.IsHaveMaterialId()){var U=new Float32Array(I);for(c=0;c<I;++c)U[c]=i.GetMaterialId(c);A["_MATERIALID"]=F(U,1,!1)}if(i.IsHaveOutlineCoord()){var R=new Int8Array(I);for(c=0;c<I;++c)R[c]=i.GetOutlineCoord(c);A["_OUTLINECOORD"]=F(R,1,!1)}var B=r.defined(A["POSITION"])?A["POSITION"].array:void 0,L=r.defined(A["_BATCHID"])?A["_BATCHID"].array:void 0,Y=u,x=d,k=f.CreatePhysicalArray.createPhysicalArrayFromModel(p,T,e.primitiveMode,B,L,Y,x);A["_PHYSICAL"]={array:k};var z={indexArray:{typedArray:u,numberOfIndices:y},attributeData:A,min:l,max:b};return p.destroy(i),z}function _(e,t){return r.defined(e.dracoType)&&e.dracoType===N.PROJECTIVE_TRANSFORM?D(e,t):r.defined(e.primitive)?r.defined(e.dracoType)&&e.dracoType===N.MATER_COMPRESSION?G(e):E(e):C(e)}function S(r,e){A.EmWrapperManager.initWebAssembly(e).then((function(){p=A.emMod,T=new p.LBSpaMgr,l=r,self.onmessage=u(_),self.postMessage(!0)}))}function h(e){var t=e.data,a=t.webAssemblyConfig;if(r.defined(a))return require([a.modulePath],(function(e){r.defined(a.wasmBinaryFile)?(r.defined(e)||(e=self.DracoDecoderModule),e(a).then((function(r){S(r,a.wasmBinaryFileES6)}))):S(e(),a.wasmBinaryFileES6)}))}return h}));