define(["./when-45f3d25d","./Check-34538dad","./Cartesian3-eab74dc0","./Cartesian2-174fefc1","./Transforms-6b57162d","./Matrix4-ed224189","./RuntimeError-86da6af2","./WebGLConstants-3660bc8f","./ComponentDatatype-86703c58","./GeometryAttribute-b1ed7c2e","./PrimitiveType-30fa6f85","./IndexDatatype-cb635cbc","./createTaskProcessorWorker","./AxisAlignedBoundingBox-804b7aeb","./EllipsoidRhumbLine-de5cdc57","./PolygonPipeline-b585c3c1","./CreatePhysicalArray-62163d3f","./materem-cccd3124","./EmWrapperManager-83011cae","./EmLBDeal-9210927a"],(function(r,e,t,a,n,o,i,d,I,y,s,f,u,c,A,m,l,p,b,T){"use strict";var N,w,v,O={DRACO_COMPRESSION:0,MATER_COMPRESSION:1,PROJECTIVE_TRANSFORM:2,POINT_CLOUD:3},P=Object.freeze(O);function C(r,e){for(var t=r.num_points(),a=r.num_faces(),n=new N.DracoInt32Array,o=3*a,i=f.IndexDatatype.createTypedArray(t,o),d=0,I=0;I<a;++I)e.GetFaceFromMesh(r,I,n),i[d+0]=n.GetValue(0),i[d+1]=n.GetValue(1),i[d+2]=n.GetValue(2),d+=3;return N.destroy(n),{typedArray:i,numberOfIndices:o}}function E(r,e,t,a,n){var o,i;a.quantizationBits<=8?(i=new N.DracoUInt8Array,o=new Uint8Array(n),e.GetAttributeUInt8ForAllPoints(r,t,i)):(i=new N.DracoUInt16Array,o=new Uint16Array(n),e.GetAttributeUInt16ForAllPoints(r,t,i));for(var d=0;d<n;++d)o[d]=i.GetValue(d);return N.destroy(i),o}function D(r,e,t,a){var n,o;switch(t.data_type()){case 1:case 11:o=new N.DracoInt8Array,n=new Int8Array(a),e.GetAttributeInt8ForAllPoints(r,t,o);break;case 2:o=new N.DracoUInt8Array,n=new Uint8Array(a),e.GetAttributeUInt8ForAllPoints(r,t,o);break;case 3:o=new N.DracoInt16Array,n=new Int16Array(a),e.GetAttributeInt16ForAllPoints(r,t,o);break;case 4:o=new N.DracoUInt16Array,n=new Uint16Array(a),e.GetAttributeUInt16ForAllPoints(r,t,o);break;case 5:case 7:o=new N.DracoInt32Array,n=new Int32Array(a),e.GetAttributeInt32ForAllPoints(r,t,o);break;case 6:case 8:o=new N.DracoUInt32Array,n=new Uint32Array(a),e.GetAttributeUInt32ForAllPoints(r,t,o);break;case 9:case 10:o=new N.DracoFloat32Array,n=new Float32Array(a),e.GetAttributeFloatForAllPoints(r,t,o);break}for(var i=0;i<a;++i)n[i]=o.GetValue(i);return N.destroy(o),n}function h(e,t,a){var n,o=e.num_points(),i=a.num_components(),d=new N.AttributeQuantizationTransform;if(d.InitFromAttribute(a)){for(var y=new Array(i),s=0;s<i;++s)y[s]=d.min_value(s);n={quantizationBits:d.quantization_bits(),minValues:y,range:d.range(),octEncoded:!1}}N.destroy(d),d=new N.AttributeOctahedronTransform,d.InitFromAttribute(a)&&(n={quantizationBits:d.quantization_bits(),octEncoded:!0}),N.destroy(d);var f,u=o*i;f=r.defined(n)?E(e,t,a,n,u):D(e,t,a,u);var c=I.ComponentDatatype.fromTypedArray(f);return{array:f,data:{componentsPerAttribute:i,componentDatatype:c,byteOffset:a.byte_offset(),byteStride:I.ComponentDatatype.getSizeInBytes(c)*i,normalized:a.normalized(),quantization:n}}}function G(r){var e=new N.Decoder;r.dequantizeInShader&&(e.SkipAttributeTransform(N.POSITION),e.SkipAttributeTransform(N.NORMAL));var t=new N.DecoderBuffer;t.Init(r.buffer,r.buffer.length);var a=e.GetEncodedGeometryType(t);if(a!==N.POINT_CLOUD)throw new i.RuntimeError("Draco geometry type must be POINT_CLOUD.");var n=new N.PointCloud,o=e.DecodeBufferToPointCloud(t,n);if(!o.ok()||0===n.ptr)throw new i.RuntimeError("Error decoding draco point cloud: "+o.error_msg());N.destroy(t);var d={},I=r.properties;for(var y in I)if(I.hasOwnProperty(y)){var s=I[y],f=e.GetAttributeByUniqueId(n,s);d[y]=h(n,e,f)}return N.destroy(n),N.destroy(e),d}function F(e){var a=new N.Decoder,n=["POSITION","NORMAL","COLOR","TEX_COORD"];if(e.dequantizeInShader)for(var d=0;d<n.length;++d)a.SkipAttributeTransform(N[n[d]]);var I=e.bufferView,y=new N.DecoderBuffer;y.Init(e.array,I.byteLength);var s=a.GetEncodedGeometryType(y);if(s!==N.TRIANGULAR_MESH)throw new i.RuntimeError("Unsupported draco mesh geometry type.");var f=new N.Mesh,u=a.DecodeBufferToMesh(y,f);if(!u.ok()||0===f.ptr)throw new i.RuntimeError("Error decoding draco mesh geometry: "+u.error_msg());N.destroy(y);var c={},A=[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY],m=[Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY],p=e.compressedAttributes;for(var b in p)if(p.hasOwnProperty(b)){var O=p[b],P=a.GetAttributeByUniqueId(f,O);if(c[b]=h(f,a,P),"POSITION"===b&&(e.projected||e.absPlaned)&&!e.isInstance){var E=e.isYUp,D=e.projectionString,G=e.dCenX,F=e.dCenY,_=e.dCenZ,S=new T.EmLBDeal,g=S.init(D,new t.Cartesian3(G,F,_));if(g){r.defined(e.planishBorderInfoAry)&&S.setPlanishBorderInfoAry(e.planishBorderInfoAry);var M=c[b].array,V=e.matrix;e.projected?S.computeProjToCartesianAry(M,E,o.Matrix4.fromArray(V)):S.computeCartesianToProjAry(M,E,o.Matrix4.fromArray(V));for(var B=new Float32Array(M.length),R=0;R<M.length;++R)B[R]=M[R],A[R%3]>B[R]&&(A[R%3]=B[R]),m[R%3]<B[R]&&(m[R%3]=B[R]);c[b].array=B}S.destroy()}}var U,L=C(f,a),x=r.defined(c["POSITION"])?c["POSITION"].array:void 0,Y=r.defined(c["_BATCHID"])?c["_BATCHID"].array:void 0,k=L.typedArray,z=l.CreatePhysicalArray.createPhysicalArrayFromModel(w,v,e.primitiveMode,x,Y,k,U);c["_PHYSICAL"]={array:z};var j={indexArray:L,attributeData:c,min:A,max:m};return N.destroy(f),N.destroy(a),j}function _(r,e){var a={};if(r.projected){var n=r.isYUp,i=r.projectionString,d=r.dCenX,I=r.dCenY,y=r.dCenZ,s=new T.EmLBDeal,f=s.init(i,new t.Cartesian3(d,I,y));if(f){var u=new Float32Array(r.array.buffer,0),c=r.matrix;s.computeProjToCartesianAry(u,n,o.Matrix4.fromArray(c));for(var A=new Float32Array(u.length),m=0;m<u.length;++m)A[m]=u[m];a={attributeData:A},e.push(A.buffer)}s.destroy()}return a}function S(r,e,t){var a=I.ComponentDatatype.fromTypedArray(r);return{array:r,data:{componentsPerAttribute:e,componentDatatype:a,byteOffset:0,byteStride:I.ComponentDatatype.getSizeInBytes(a)*e,normalized:t,quantization:void 0}}}function g(e){var a=e.bufferView,n=new w.MaterPrimitiveDecoder;if(!n.Decode(e.array,a.byteLength))throw w.destroy(n),new i.RuntimeError("error mater compress.");for(var d,I=n.GetPtNum(),y=n.GetIndexNum(),s=f.IndexDatatype.createTypedArray(I,y),u=0;u<y;++u)s[u]=n.GetIndex(u);if(n.IsHaveEdgeCheck())for(d=new Int8Array(y),u=0;u<y;++u)d[u]=n.GetEdgeCheck(u);var c={},A=[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY],m=[Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY],p=new Float32Array(3*I);for(u=0;u<I;++u)p[3*u]=n.GetPtVal(u,0),p[3*u+1]=n.GetPtVal(u,1),p[3*u+2]=n.GetPtVal(u,2);if(c["POSITION"]=S(p,3,!1),(e.projected||e.absPlaned)&&!e.isInstance){var b=e.isYUp,N=e.projectionString,O=e.dCenX,P=e.dCenY,C=e.dCenZ,E=new T.EmLBDeal,D=E.init(N,new t.Cartesian3(O,P,C));if(D){var h=c["POSITION"].array,G=e.matrix;e.projected?E.computeProjToCartesianAry(h,b,o.Matrix4.fromArray(G)):E.computeCartesianToProjAry(h,b,o.Matrix4.fromArray(G));for(var F=new Float32Array(h.length),_=0;_<h.length;++_)F[_]=h[_],A[_%3]>F[_]&&(A[_%3]=F[_]),m[_%3]<F[_]&&(m[_%3]=F[_]);c["POSITION"].array=F}E.destroy()}if(n.IsHaveUV()){var g=new Float32Array(2*I);for(u=0;u<I;++u)g[2*u]=n.GetUVVal(u,0),g[2*u+1]=n.GetUVVal(u,1);c["TEXCOORD_0"]=S(g,2,!1)}if(n.IsHaveNormal()){var M=new Float32Array(3*I);for(u=0;u<I;++u)M[3*u]=n.GetNormalVal(u,0),M[3*u+1]=n.GetNormalVal(u,1),M[3*u+2]=n.GetNormalVal(u,2);c["NORMAL"]=S(M,3,!0)}if(n.IsHaveBatchId()){var V=new Float32Array(I);for(u=0;u<I;++u)V[u]=n.GetBatchId(u);c["_BATCHID"]=S(V,1,!1)}if(n.IsHaveMaterialId()){var B=new Float32Array(I);for(u=0;u<I;++u)B[u]=n.GetMaterialId(u);c["_MATERIALID"]=S(B,1,!1)}if(n.IsHaveOutlineCoord()){var R=new Int8Array(I);for(u=0;u<I;++u)R[u]=n.GetOutlineCoord(u);c["_OUTLINECOORD"]=S(R,1,!1)}var U=r.defined(c["POSITION"])?c["POSITION"].array:void 0,L=r.defined(c["_BATCHID"])?c["_BATCHID"].array:void 0,x=s,Y=d,k=l.CreatePhysicalArray.createPhysicalArrayFromModel(w,v,e.primitiveMode,U,L,x,Y);c["_PHYSICAL"]={array:k};var z={indexArray:{typedArray:s,numberOfIndices:y},attributeData:c,min:A,max:m};return w.destroy(n),z}function M(e,t){return r.defined(e.dracoType)&&e.dracoType===P.PROJECTIVE_TRANSFORM?_(e,t):r.defined(e.primitive)?r.defined(e.dracoType)&&e.dracoType===P.MATER_COMPRESSION?g(e):F(e):G(e)}function V(r,e){b.EmWrapperManager.initWebAssembly(e).then((function(){w=b.emMod,v=new w.LBSpaMgr,N=r,self.onmessage=u(M),self.postMessage(!0)}))}function B(e){var t=e.data,a=t.webAssemblyConfig;if(r.defined(a))return require([a.modulePath],(function(e){r.defined(a.wasmBinaryFile)?(r.defined(e)||(e=self.DracoDecoderModule),e(a).then((function(r){V(r,a.wasmBinaryFileES6)}))):V(e(),a.wasmBinaryFileES6)}))}return B}));