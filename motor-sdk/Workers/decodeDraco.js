define(["./when-45f3d25d","./Check-34538dad","./Cartesian3-ef6ea826","./Cartesian2-a652b463","./Transforms-c8a82813","./Matrix4-f54b529f","./RuntimeError-86da6af2","./WebGLConstants-3660bc8f","./ComponentDatatype-d28c2e26","./GeometryAttribute-dfebcc43","./PrimitiveType-30fa6f85","./IndexDatatype-6d2070e9","./createTaskProcessorWorker","./AxisAlignedBoundingBox-9187558e","./EllipsoidRhumbLine-0c6cd7c8","./PolygonPipeline-28c8c9d7","./CreatePhysicalArray-2cb6a1d4","./materem-cccd3124","./EmWrapperManager-83011cae","./EmLBDeal-6e17a961"],(function(e,r,t,a,n,o,i,d,y,I,s,f,u,c,A,m,l,p,T,b){"use strict";var N,w,v,P=Object.freeze({DRACO_COMPRESSION:0,MATER_COMPRESSION:1,PROJECTIVE_TRANSFORM:2,POINT_CLOUD:3});function O(r,t,a){var n,o=r.num_points(),i=a.num_components(),d=new N.AttributeQuantizationTransform;if(d.InitFromAttribute(a)){for(var I=new Array(i),s=0;s<i;++s)I[s]=d.min_value(s);n={quantizationBits:d.quantization_bits(),minValues:I,range:d.range(),octEncoded:!1}}N.destroy(d),(d=new N.AttributeOctahedronTransform).InitFromAttribute(a)&&(n={quantizationBits:d.quantization_bits(),octEncoded:!0}),N.destroy(d);var f,u=o*i;f=e.defined(n)?function(e,r,t,a,n){var o,i;a.quantizationBits<=8?(i=new N.DracoUInt8Array,o=new Uint8Array(n),r.GetAttributeUInt8ForAllPoints(e,t,i)):(i=new N.DracoUInt16Array,o=new Uint16Array(n),r.GetAttributeUInt16ForAllPoints(e,t,i));for(var d=0;d<n;++d)o[d]=i.GetValue(d);return N.destroy(i),o}(r,t,a,n,u):function(e,r,t,a){var n,o;switch(t.data_type()){case 1:case 11:o=new N.DracoInt8Array,n=new Int8Array(a),r.GetAttributeInt8ForAllPoints(e,t,o);break;case 2:o=new N.DracoUInt8Array,n=new Uint8Array(a),r.GetAttributeUInt8ForAllPoints(e,t,o);break;case 3:o=new N.DracoInt16Array,n=new Int16Array(a),r.GetAttributeInt16ForAllPoints(e,t,o);break;case 4:o=new N.DracoUInt16Array,n=new Uint16Array(a),r.GetAttributeUInt16ForAllPoints(e,t,o);break;case 5:case 7:o=new N.DracoInt32Array,n=new Int32Array(a),r.GetAttributeInt32ForAllPoints(e,t,o);break;case 6:case 8:o=new N.DracoUInt32Array,n=new Uint32Array(a),r.GetAttributeUInt32ForAllPoints(e,t,o);break;case 9:case 10:o=new N.DracoFloat32Array,n=new Float32Array(a),r.GetAttributeFloatForAllPoints(e,t,o)}for(var i=0;i<a;++i)n[i]=o.GetValue(i);return N.destroy(o),n}(r,t,a,u);var c=y.ComponentDatatype.fromTypedArray(f);return{array:f,data:{componentsPerAttribute:i,componentDatatype:c,byteOffset:a.byte_offset(),byteStride:y.ComponentDatatype.getSizeInBytes(c)*i,normalized:a.normalized(),quantization:n}}}function C(r){var a=new N.Decoder,n=["POSITION","NORMAL","COLOR","TEX_COORD"];if(r.dequantizeInShader)for(var d=0;d<n.length;++d)a.SkipAttributeTransform(N[n[d]]);var y=r.bufferView,I=new N.DecoderBuffer;if(I.Init(r.array,y.byteLength),a.GetEncodedGeometryType(I)!==N.TRIANGULAR_MESH)throw new i.RuntimeError("Unsupported draco mesh geometry type.");var s=new N.Mesh,u=a.DecodeBufferToMesh(I,s);if(!u.ok()||0===s.ptr)throw new i.RuntimeError("Error decoding draco mesh geometry: "+u.error_msg());N.destroy(I);var c={},A=[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY],m=[Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY],p=r.compressedAttributes;for(var T in p)if(p.hasOwnProperty(T)){var P=p[T],C=a.GetAttributeByUniqueId(s,P);if(c[T]=O(s,a,C),"POSITION"===T&&(r.projected||r.absPlaned)&&!r.isInstance){var E=r.isYUp,D=r.projectionString,h=r.dCenX,G=r.dCenY,F=r.dCenZ,_=new b.EmLBDeal;if(_.init(D,new t.Cartesian3(h,G,F))){e.defined(r.planishBorderInfoAry)&&_.setPlanishBorderInfoAry(r.planishBorderInfoAry);var S=c[T].array,g=r.matrix;r.projected?_.computeProjToCartesianAry(S,E,o.Matrix4.fromArray(g)):_.computeCartesianToProjAry(S,E,o.Matrix4.fromArray(g));for(var M=new Float32Array(S.length),V=0;V<S.length;++V)M[V]=S[V],A[V%3]>M[V]&&(A[V%3]=M[V]),m[V%3]<M[V]&&(m[V%3]=M[V]);c[T].array=M}_.destroy()}}var B=function(e,r){for(var t=e.num_points(),a=e.num_faces(),n=new N.DracoInt32Array,o=3*a,i=f.IndexDatatype.createTypedArray(t,o),d=0,y=0;y<a;++y)r.GetFaceFromMesh(e,y,n),i[d+0]=n.GetValue(0),i[d+1]=n.GetValue(1),i[d+2]=n.GetValue(2),d+=3;return N.destroy(n),{typedArray:i,numberOfIndices:o}}(s,a);if(r.isNeedPhy){var R=e.defined(c.POSITION)?c.POSITION.array:void 0,U=e.defined(c._BATCHID)?c._BATCHID.array:void 0,L=B.typedArray,x=l.CreatePhysicalArray.createPhysicalArrayFromModel(w,v,r.primitiveMode,R,U,L,void 0);c._PHYSICAL={array:x}}var Y={indexArray:B,attributeData:c,min:A,max:m};return N.destroy(s),N.destroy(a),Y}function E(e,r,t){var a=y.ComponentDatatype.fromTypedArray(e);return{array:e,data:{componentsPerAttribute:r,componentDatatype:a,byteOffset:0,byteStride:y.ComponentDatatype.getSizeInBytes(a)*r,normalized:t,quantization:void 0}}}function D(r,a){return e.defined(r.dracoType)&&r.dracoType===P.PROJECTIVE_TRANSFORM?function(e,r){var a={};if(e.projected){var n=e.isYUp,i=e.projectionString,d=e.dCenX,y=e.dCenY,I=e.dCenZ,s=new b.EmLBDeal;if(s.init(i,new t.Cartesian3(d,y,I))){var f=new Float32Array(e.array.buffer,0),u=e.matrix;s.computeProjToCartesianAry(f,n,o.Matrix4.fromArray(u));for(var c=new Float32Array(f.length),A=0;A<f.length;++A)c[A]=f[A];a={attributeData:c},r.push(c.buffer)}s.destroy()}return a}(r,a):e.defined(r.primitive)?e.defined(r.dracoType)&&r.dracoType===P.MATER_COMPRESSION?function(r){var a=r.bufferView,n=new w.MaterPrimitiveDecoder;if(!n.Decode(r.array,a.byteLength))throw w.destroy(n),new i.RuntimeError("error mater compress.");for(var d,y=n.GetPtNum(),I=n.GetIndexNum(),s=f.IndexDatatype.createTypedArray(y,I),u=0;u<I;++u)s[u]=n.GetIndex(u);if(n.IsHaveEdgeCheck())for(d=new Int8Array(I),u=0;u<I;++u)d[u]=n.GetEdgeCheck(u);var c={},A=[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY],m=[Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY],p=new Float32Array(3*y);for(u=0;u<y;++u)p[3*u]=n.GetPtVal(u,0),p[3*u+1]=n.GetPtVal(u,1),p[3*u+2]=n.GetPtVal(u,2);if(c.POSITION=E(p,3,!1),(r.projected||r.absPlaned)&&!r.isInstance){var T=r.isYUp,N=r.projectionString,P=r.dCenX,O=r.dCenY,C=r.dCenZ,D=new b.EmLBDeal;if(D.init(N,new t.Cartesian3(P,O,C))){var h=c.POSITION.array,G=r.matrix;r.projected?D.computeProjToCartesianAry(h,T,o.Matrix4.fromArray(G)):D.computeCartesianToProjAry(h,T,o.Matrix4.fromArray(G));for(var F=new Float32Array(h.length),_=0;_<h.length;++_)F[_]=h[_],A[_%3]>F[_]&&(A[_%3]=F[_]),m[_%3]<F[_]&&(m[_%3]=F[_]);c.POSITION.array=F}D.destroy()}if(n.IsHaveUV()){var S=new Float32Array(2*y);for(u=0;u<y;++u)S[2*u]=n.GetUVVal(u,0),S[2*u+1]=n.GetUVVal(u,1);c.TEXCOORD_0=E(S,2,!1)}if(n.IsHaveNormal()){var g=new Float32Array(3*y);for(u=0;u<y;++u)g[3*u]=n.GetNormalVal(u,0),g[3*u+1]=n.GetNormalVal(u,1),g[3*u+2]=n.GetNormalVal(u,2);c.NORMAL=E(g,3,!0)}if(n.IsHaveBatchId()){var M=new Float32Array(y);for(u=0;u<y;++u)M[u]=n.GetBatchId(u);c._BATCHID=E(M,1,!1)}if(n.IsHaveMaterialId()){var V=new Float32Array(y);for(u=0;u<y;++u)V[u]=n.GetMaterialId(u);c._MATERIALID=E(V,1,!1)}if(n.IsHaveOutlineCoord()){var B=new Int8Array(y);for(u=0;u<y;++u)B[u]=n.GetOutlineCoord(u);c._OUTLINECOORD=E(B,1,!1)}if(r.isNeedPhy){var R=e.defined(c.POSITION)?c.POSITION.array:void 0,U=e.defined(c._BATCHID)?c._BATCHID.array:void 0,L=s,x=d,Y=l.CreatePhysicalArray.createPhysicalArrayFromModel(w,v,r.primitiveMode,R,U,L,x);c._PHYSICAL={array:Y}}var k={indexArray:{typedArray:s,numberOfIndices:I},attributeData:c,min:A,max:m};return w.destroy(n),k}(r):C(r):function(e){var r=new N.Decoder;e.dequantizeInShader&&(r.SkipAttributeTransform(N.POSITION),r.SkipAttributeTransform(N.NORMAL));var t=new N.DecoderBuffer;if(t.Init(e.buffer,e.buffer.length),r.GetEncodedGeometryType(t)!==N.POINT_CLOUD)throw new i.RuntimeError("Draco geometry type must be POINT_CLOUD.");var a=new N.PointCloud,n=r.DecodeBufferToPointCloud(t,a);if(!n.ok()||0===a.ptr)throw new i.RuntimeError("Error decoding draco point cloud: "+n.error_msg());N.destroy(t);var o={},d=e.properties;for(var y in d)if(d.hasOwnProperty(y)){var I=d[y],s=r.GetAttributeByUniqueId(a,I);o[y]=O(a,r,s)}return N.destroy(a),N.destroy(r),o}(r)}function h(e,r){T.EmWrapperManager.initWebAssembly(r).then((function(){w=T.emMod,v=new w.LBSpaMgr,N=e,self.onmessage=u(D),self.postMessage(!0)}))}return function(r){var t=r.data.webAssemblyConfig;if(e.defined(t))return require([t.modulePath],(function(r){e.defined(t.wasmBinaryFile)?(e.defined(r)||(r=self.DracoDecoderModule),r(t).then((function(e){h(e,t.wasmBinaryFileES6)}))):h(r(),t.wasmBinaryFileES6)}))}}));