define(["./when-45f3d25d","./Check-34538dad","./Cartesian3-eab74dc0","./Matrix4-22b96d31","./RuntimeError-86da6af2","./WebGLConstants-3660bc8f","./PrimitiveType-30fa6f85","./createTaskProcessorWorker","./CreatePhysicalArray-c5e20c39","./materem-cccd3124","./EmWrapperManager-83011cae"],(function(e,t,r,i,a,n,o,s,l,d,f){"use strict";var c,P,m,v,y,u,M,x={ADD_PRIMITIVE:0,UPDATE:1,PICK_FROM_RAY:2,UPDATE_INSTANCE_MATRIX:3,UPDATE_PRIMITIVE_MATRIX:4},I=Object.freeze(x),p={X:0,Y:1,Z:2,Y_UP_TO_Z_UP:i.Matrix4.fromRotationTranslation(i.Matrix3.fromRotationX(r.CesiumMath.PI_OVER_TWO)),Z_UP_TO_Y_UP:i.Matrix4.fromRotationTranslation(i.Matrix3.fromRotationX(-r.CesiumMath.PI_OVER_TWO)),X_UP_TO_Z_UP:i.Matrix4.fromRotationTranslation(i.Matrix3.fromRotationY(-r.CesiumMath.PI_OVER_TWO)),Z_UP_TO_X_UP:i.Matrix4.fromRotationTranslation(i.Matrix3.fromRotationY(r.CesiumMath.PI_OVER_TWO)),X_UP_TO_Y_UP:i.Matrix4.fromRotationTranslation(i.Matrix3.fromRotationZ(r.CesiumMath.PI_OVER_TWO)),Y_UP_TO_X_UP:i.Matrix4.fromRotationTranslation(i.Matrix3.fromRotationZ(-r.CesiumMath.PI_OVER_TWO)),fromName:function(e){return t.Check.typeOf.string("name",e),p[e]}},_=Object.freeze(p),A=i.Matrix4.toArray(_.Y_UP_TO_Z_UP),T=new i.Matrix4,h=new i.Matrix4,R=new i.Matrix4;function g(e){switch(e.logicType){case I.UPDATE_INSTANCE_MATRIX:z(e);break;case I.ADD_PRIMITIVE:S(e);break;case I.UPDATE_PRIMITIVE_MATRIX:C(e);break;case I.UPDATE:P.EnableAllPrimitiveSelected(!1),G(e.selectedModelIdArray),E(e.selectedModelIdIndexArray),D(e.removedModelIdArray);break;case I.PICK_FROM_RAY:return W(e);default:throw new t.DeveloperError("physicalLogicType is not a valid value.")}return!0}function G(t){if(e.defined(t)&&t.length>0)for(var r=0;r<t.length;++r){var i=t[r];if(m.has(i)){var a=m.get(i);for(var n of a)P.EnablePrimitiveSelected(n,!0)}}}function E(t){if(e.defined(t)&&t.length>0)for(var r=0;r<t.length;++r){var i=t[r].modelId,a=t[r].unSelectedIndexArray;if(m.has(i)){var n=m.get(i);for(var o of n){P.EnablePrimitiveSelected(o,!0);var s=P.GetPrimitiveCluster(o);if(0!==s.ptr){s.EnableAllIndexSelected(!0);for(let e=0;e<a.length;e++)s.EnableIndexSelected(a[e],!1)}}}}}function S(t){var r=t.primitives,i=t.modelId;if(r.length>0&&e.defined(i))for(var a of r)b(i,a)}function C(e){var t=e.primitiveMatrixArray;if(t.length>0)for(var r of t){var i=r.modelId,a=r.primitiveMatrixTypeArray;if(m.has(i))for(var n=m.get(i),o=0;o<n.length;++o){var s=n[o];O(s,a)}}}function b(t,r){var i,a,n=r.physicalArray,o=r.physicalArrayOptions,s=r.projectCenterMatrixArray;if(e.defined(n)){var d=new c.LBSpaSerial,f=c._malloc(n.byteLength);c.HEAPU8.set(n,f),a=d.ReadSpatial(f,n.byteLength),c._free(f),c.destroy(d)}if(e.defined(o)){var m=o.pPtAry,v=o.pBatchIdAry,y=o.pIndexAry,u=o.pEdgeCheckAry,M=o.primitiveMode;a=l.CreatePhysicalArray.createSpaPrimitive(c,P,M,m,v,y,u)}if(e.defined(r.instanceMatrixTypeArray)||e.defined(r.lodInstanceMatrixTypeArray)){var x=P.CreatePrimitiveCluster(a);i=P.AddPrimitiveSpatial(x);var I=e.defined(r.lodInstanceMatrixTypeArray),p=I?A:void 0,_=I?r.lodInstanceMatrixTypeArray:r.instanceMatrixTypeArray;k(x,s,p,_,I)}else i=P.AddPrimitiveSpatial(a),O(i,s);return w(t,i),i}function O(t,r){e.defined(r)&&(U(r,y),P.SetPrimitiveSpatialMat(t,y))}function k(t,r,a,n,o){e.defined(r)&&i.Matrix4.fromArray(r,0,T),e.defined(a)&&i.Matrix4.fromArray(a,0,h);for(var s=0;s<n.length;s+=16)i.Matrix4.fromArray(n,s,R),e.defined(a)&&i.Matrix4.multiply(R,h,R),!o&&e.defined(r)&&i.Matrix4.multiply(T,R,R),U(R,y),t.SetIndexMatrix(s/16,y)}function z(e){var t=e.instanceMatrixArray;for(var r of t){var i=r.modelId,a=r.instanceMatrixTypeArray;if(m.has(i))for(var n=m.get(i),o=0;o<n.length;++o){var s=n[o],l=P.GetPrimitiveCluster(s);0!==l.ptr&&(l.RemoveAllMatrix(),k(l,void 0,A,a,!0))}}}function U(e,t){for(var r=0;r<4;++r){var i=t.At(r);i.x=e[4*r],i.y=e[4*r+1],i.z=e[4*r+2],i.w=e[4*r+3]}}function w(e,t){var r;m.has(e)?(r=m.get(e),r.push(t)):(r=[],r.push(t),m.set(e,r)),v.set(t,e)}function D(t){if(e.defined(t)&&t.length>0)for(var r=0;r<t.length;++r){var i=t[r];if(m.has(i)){var a=m.get(i);for(var n of a)P.RemovePrimitiveSpatial(n),v.delete(n);m.delete(i)}}}function W(t){var r={},i=t.ray,a=t.triangleMode,n=t.lineMode,o=e.defined(t.maxDist)?t.maxDist:.1;if(u.SetRay(i[0],i[1],i[2],i[3],i[4],i[5],o,a,n),P.Select(u,M)){if(a){r.triPrimitives=[];for(let e=0;e<M.GetTriResultElemSize();++e){const t={};X(M.GetTriResultElem(e),t),r.triPrimitives.push(t)}}if(n){r.segPrimitives=[];for(let e=0;e<M.GetSegResultElemSize();++e){const t={};V(M.GetSegResultElem(e),t),r.segPrimitives.push(t)}}}return M.ClearAll(),r}function X(e,t){t.modelId=v.get(e.GetResultId().iPrimitiveId),t.isCluster=e.GetResultId().bCluster,t.batchId=e.GetResultId().iBatchId,t.vertices=[{x:e.GetPt0().x,y:e.GetPt0().y,z:e.GetPt0().z},{x:e.GetPt1().x,y:e.GetPt1().y,z:e.GetPt1().z},{x:e.GetPt2().x,y:e.GetPt2().y,z:e.GetPt2().z}],t.pickPt={x:e.GetPickPt().x,y:e.GetPickPt().y,z:e.GetPickPt().z},t.pickDist=e.GetPickDist()}function V(e,t){t.modelId=v.get(e.GetResultId().iPrimitiveId),t.isCluster=e.GetResultId().bCluster,t.batchId=e.GetResultId().iBatchId,t.vertices=[{x:e.GetPt0().x,y:e.GetPt0().y,z:e.GetPt0().z},{x:e.GetPt1().x,y:e.GetPt1().y,z:e.GetPt1().z}],t.segPt={x:e.GetSegPt().x,y:e.GetSegPt().y,z:e.GetSegPt().z},t.pickPt={x:e.GetPickPt().x,y:e.GetPickPt().y,z:e.GetPickPt().z},t.pickDist=e.GetPickDist()}function Y(){P=new c.LBSpaMgr,m=new Map,v=new Map,y=new c.LBSpaMat,u=new c.LBSpaSelectCondition,M=new c.LBSpaSelectResult}function B(t){var r=t.data,i=r.webAssemblyConfig;if(e.defined(i)){if(e.defined(i.debug))return require([i.debug],(function(e){c=e(),Y(),self.onmessage=s(g),self.postMessage(!0)}));f.EmWrapperManager.initWebAssembly(i.wasmBinaryFileES6).then((function(){c=f.emMod,Y(),self.onmessage=s(g),self.postMessage(!0)}))}}return B}));