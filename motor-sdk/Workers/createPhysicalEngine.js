define(["./when-52cea266","./Check-ee5dd8a8","./Cartesian2-7c55a82d","./Matrix4-da50dd55","./RuntimeError-02840484","./WebGLConstants-52779751","./PrimitiveType-875d1f73","./createTaskProcessorWorker","./CreatePhysicalArray-56a321cf","./materem-0b1d1e36","./EmWrapperManager-2288e917"],(function(e,t,r,i,a,n,o,l,s,d,f){"use strict";var P,c,m,y,v,u,M,x={ADD_PRIMITIVE:0,UPDATE:1,PICK_FROM_RAY:2,UPDATE_INSTANCE_MATRIX:3,UPDATE_PRIMITIVE_MATRIX:4},p=Object.freeze(x),I={X:0,Y:1,Z:2,Y_UP_TO_Z_UP:i.Matrix4.fromRotationTranslation(i.Matrix3.fromRotationX(r.CesiumMath.PI_OVER_TWO)),Z_UP_TO_Y_UP:i.Matrix4.fromRotationTranslation(i.Matrix3.fromRotationX(-r.CesiumMath.PI_OVER_TWO)),X_UP_TO_Z_UP:i.Matrix4.fromRotationTranslation(i.Matrix3.fromRotationY(-r.CesiumMath.PI_OVER_TWO)),Z_UP_TO_X_UP:i.Matrix4.fromRotationTranslation(i.Matrix3.fromRotationY(r.CesiumMath.PI_OVER_TWO)),X_UP_TO_Y_UP:i.Matrix4.fromRotationTranslation(i.Matrix3.fromRotationZ(r.CesiumMath.PI_OVER_TWO)),Y_UP_TO_X_UP:i.Matrix4.fromRotationTranslation(i.Matrix3.fromRotationZ(-r.CesiumMath.PI_OVER_TWO)),fromName:function(e){return t.Check.typeOf.string("name",e),I[e]}},_=Object.freeze(I),A=i.Matrix4.toArray(_.Y_UP_TO_Z_UP),T=new i.Matrix4,h=new i.Matrix4,R=new i.Matrix4;function g(e){switch(e.logicType){case p.UPDATE_INSTANCE_MATRIX:z(e);break;case p.ADD_PRIMITIVE:S(e);break;case p.UPDATE_PRIMITIVE_MATRIX:C(e);break;case p.UPDATE:c.EnableAllPrimitiveSelected(!1),G(e.selectedModelIdArray),E(e.selectedModelIdIndexArray),D(e.removedModelIdArray);break;case p.PICK_FROM_RAY:return W(e);default:throw new t.DeveloperError("physicalLogicType is not a valid value.")}return!0}function G(t){if(e.defined(t)&&t.length>0)for(var r=0;r<t.length;++r){var i=t[r];if(m.has(i)){var a=m.get(i);for(var n of a)c.EnablePrimitiveSelected(n,!0)}}}function E(t){if(e.defined(t)&&t.length>0)for(var r=0;r<t.length;++r){var i=t[r].modelId,a=t[r].unSelectedIndexArray;if(m.has(i)){var n=m.get(i);for(var o of n){c.EnablePrimitiveSelected(o,!0);var l=c.GetPrimitiveCluster(o);if(0!==l.ptr){l.EnableAllIndexSelected(!0);for(let e=0;e<a.length;e++)l.EnableIndexSelected(a[e],!1)}}}}}function S(t){var r=t.primitives,i=t.modelId;if(r.length>0&&e.defined(i))for(var a of r)b(i,a)}function C(e){var t=e.primitiveMatrixArray;if(t.length>0)for(var r of t){var i=r.modelId,a=r.primitiveMatrixTypeArray;if(m.has(i))for(var n=m.get(i),o=0;o<n.length;++o){var l=n[o];k(l,a)}}}function b(t,r){var i,a,n=r.physicalArray,o=r.physicalArrayOptions,l=r.projectCenterMatrixArray;if(e.defined(n)){var d=new P.LBSpaSerial,f=P._malloc(n.byteLength);P.HEAPU8.set(n,f),a=d.ReadSpatial(f,n.byteLength),P._free(f),P.destroy(d)}if(e.defined(o)){var m=o.pPtAry,y=o.pBatchIdAry,v=o.pIndexAry,u=o.pEdgeCheckAry,M=o.primitiveMode;a=s.CreatePhysicalArray.createSpaPrimitive(P,c,M,m,y,v,u)}if(e.defined(r.instanceMatrixTypeArray)||e.defined(r.lodInstanceMatrixTypeArray)){var x=c.CreatePrimitiveCluster(a);i=c.AddPrimitiveSpatial(x);var p=e.defined(r.lodInstanceMatrixTypeArray),I=p?A:void 0,_=p?r.lodInstanceMatrixTypeArray:r.instanceMatrixTypeArray;O(x,l,I,_,p)}else i=c.AddPrimitiveSpatial(a),k(i,l);return w(t,i),i}function k(t,r){e.defined(r)&&(U(r,v),c.SetPrimitiveSpatialMat(t,v))}function O(t,r,a,n,o){e.defined(r)&&i.Matrix4.fromArray(r,0,T),e.defined(a)&&i.Matrix4.fromArray(a,0,h);for(var l=0;l<n.length;l+=16)i.Matrix4.fromArray(n,l,R),e.defined(a)&&i.Matrix4.multiply(R,h,R),!o&&e.defined(r)&&i.Matrix4.multiply(T,R,R),U(R,v),t.SetIndexMatrix(l/16,v)}function z(e){var t=e.instanceMatrixArray;for(var r of t){var i=r.modelId,a=r.instanceMatrixTypeArray;if(m.has(i))for(var n=m.get(i),o=0;o<n.length;++o){var l=n[o],s=c.GetPrimitiveCluster(l);0!==s.ptr&&(s.RemoveAllMatrix(),O(s,void 0,A,a,!0))}}}function U(e,t){for(var r=0;r<4;++r){var i=t.At(r);i.x=e[4*r],i.y=e[4*r+1],i.z=e[4*r+2],i.w=e[4*r+3]}}function w(e,t){var r;m.has(e)?(r=m.get(e),r.push(t)):(r=[],r.push(t),m.set(e,r)),y.set(t,e)}function D(t){if(e.defined(t)&&t.length>0)for(var r=0;r<t.length;++r){var i=t[r];if(m.has(i)){var a=m.get(i);for(var n of a)c.RemovePrimitiveSpatial(n),y.delete(n);m.delete(i)}}}function W(t){var r={},i=t.ray,a=t.triangleMode,n=t.lineMode,o=e.defined(t.maxDist)?t.maxDist:.1;if(u.SetRay(i[0],i[1],i[2],i[3],i[4],i[5],o,a,n),c.Select(u,M)){if(a){r.triPrimitives=[];for(let e=0;e<M.GetTriResultElemSize();++e){const t={};X(M.GetTriResultElem(e),t),r.triPrimitives.push(t)}}if(n){r.segPrimitives=[];for(let e=0;e<M.GetSegResultElemSize();++e){const t={};V(M.GetSegResultElem(e),t),r.segPrimitives.push(t)}}}return M.ClearAll(),r}function X(e,t){t.modelId=y.get(e.GetResultId().iPrimitiveId),t.isCluster=e.GetResultId().bCluster,t.batchId=e.GetResultId().iBatchId,t.vertices=[{x:e.GetPt0().x,y:e.GetPt0().y,z:e.GetPt0().z},{x:e.GetPt1().x,y:e.GetPt1().y,z:e.GetPt1().z},{x:e.GetPt2().x,y:e.GetPt2().y,z:e.GetPt2().z}],t.pickPt={x:e.GetPickPt().x,y:e.GetPickPt().y,z:e.GetPickPt().z},t.pickNormal={x:e.GetPickNormal().x,y:e.GetPickNormal().y,z:e.GetPickNormal().z},t.pickDist=e.GetPickDist()}function V(e,t){t.modelId=y.get(e.GetResultId().iPrimitiveId),t.isCluster=e.GetResultId().bCluster,t.batchId=e.GetResultId().iBatchId,t.vertices=[{x:e.GetPt0().x,y:e.GetPt0().y,z:e.GetPt0().z},{x:e.GetPt1().x,y:e.GetPt1().y,z:e.GetPt1().z}],t.segPt={x:e.GetSegPt().x,y:e.GetSegPt().y,z:e.GetSegPt().z},t.pickPt={x:e.GetPickPt().x,y:e.GetPickPt().y,z:e.GetPickPt().z},t.pickDist=e.GetPickDist()}function Y(){c=new P.LBSpaMgr,m=new Map,y=new Map,v=new P.LBSpaMat,u=new P.LBSpaSelectCondition,M=new P.LBSpaSelectResult}function B(t){var r=t.data,i=r.webAssemblyConfig;if(e.defined(i)){if(e.defined(i.debug))return require([i.debug],(function(e){P=e(),Y(),self.onmessage=l(g),self.postMessage(!0)}));f.EmWrapperManager.initWebAssembly(i.wasmBinaryFileES6).then((function(){P=f.emMod,Y(),self.onmessage=l(g),self.postMessage(!0)}))}}return B}));