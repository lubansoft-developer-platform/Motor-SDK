define(["./when-45f3d25d","./Check-34538dad","./Cartesian3-ef6ea826","./Cartesian2-a652b463","./BoundingSphere-038d5fbc","./Transforms-c8a82813","./Matrix4-f54b529f","./RuntimeError-86da6af2","./WebGLConstants-3660bc8f","./ComponentDatatype-d28c2e26","./GeometryAttribute-dfebcc43","./PrimitiveType-30fa6f85","./AttributeCompression-20de7c5b","./IndexDatatype-6d2070e9","./IntersectionTests-b186d985","./Plane-a0c58786","./WebMercatorProjection-cf88bfd1","./createTaskProcessorWorker","./AxisAlignedBoundingBox-9187558e","./EllipsoidTangentPlane-dd3d1016","./OrientedBoundingBox-91354f3d","./EllipsoidRhumbLine-0c6cd7c8","./PolygonPipeline-28c8c9d7","./CreatePhysicalArray-2cb6a1d4","./materem-cccd3124","./EmWrapperManager-83011cae","./TerrainEncoding-c24a22bc","./TerrainProvider-7f3602bf","./EmLBDeal-6e17a961"],(function(e,t,r,n,i,a,o,d,s,l,u,c,h,m,f,g,I,p,y,T,M,x,b,C,N,v,P,A,w){"use strict";var S,B=new r.Cartesian3,E=new r.Cartesian3,F=new r.Cartesian3,V=new n.Cartographic,L=new n.Cartesian2,W=new r.Cartesian3,D=new o.Matrix4,G=new o.Matrix4;function k(t,d){var s=t.quantizedVertices,l=s.length/3;if(l<3)return{holeAllData:!0};var u,c=t.octEncodedNormals,f=t.westIndices.length+t.eastIndices.length+t.southIndices.length+t.northIndices.length,g=t.includeWebMercatorT,p=t.holeAry,T=t.planishBorderInfoAry,x=e.defined(p)&&p.length>0,b=e.defined(T)&&T.length>0,N=(t.tileInfo,t.needDownLoad),k=t.isNeedPhy,_=n.Rectangle.clone(t.rectangle),O=_.west,j=_.south,H=_.east,R=_.north,U=n.Ellipsoid.clone(t.ellipsoid),q=t.exaggeration,X=t.minimumHeight*q,Z=t.maximumHeight*q,J=t.relativeToCenter;u=t.isPlaneMode?o.Matrix4.fromTranslation(J):a.Transforms.eastNorthUpToFixedFrame(J,U);var K,Q,$=o.Matrix4.inverseTransformation(u,new o.Matrix4);g&&(K=I.WebMercatorProjection.geodeticLatitudeToMercatorAngle(j),Q=1/(I.WebMercatorProjection.geodeticLatitudeToMercatorAngle(R)-K));var ee,te=s.subarray(0,l),re=s.subarray(l,2*l),ne=s.subarray(2*l,3*l),ie=e.defined(c),ae=new Array(l),oe=new Array(l),de=new Array(l),se=g?new Array(l):[];ie&&(ee=[...c]);var le=[...t.indices],ue=E;ue.x=Number.POSITIVE_INFINITY,ue.y=Number.POSITIVE_INFINITY,ue.z=Number.POSITIVE_INFINITY;var ce=F;ce.x=Number.NEGATIVE_INFINITY,ce.y=Number.NEGATIVE_INFINITY,ce.z=Number.NEGATIVE_INFINITY;var he,me=Number.POSITIVE_INFINITY,fe=Number.NEGATIVE_INFINITY,ge=Number.POSITIVE_INFINITY,Ie=Number.NEGATIVE_INFINITY,pe=!1;if(t.isPlaneMode){var ye=t.projectionString,Te=t.dCenX,Me=t.dCenY,xe=t.dCenZ;(he=new w.EmLBDeal).init(ye,new r.Cartesian3(Te,Me,xe))?b&&he.setPlanishBorderInfoAry(T):(he.destroy(),he=void 0),pe=t.isDefaultTer}for(var be=0;be<l;++be){var Ce=te[be]/32767,Ne=re[be]/32767,ve=r.CesiumMath.lerp(X,Z,ne[be]/32767);V.longitude=r.CesiumMath.lerp(O,H,Ce),V.latitude=r.CesiumMath.lerp(j,R,Ne),V.height=ve,me=Math.min(V.longitude,me),fe=Math.max(V.longitude,fe),ge=Math.min(V.latitude,ge),Ie=Math.max(V.latitude,Ie);var Pe=U.cartographicToCartesian(V);e.defined(he)&&(Pe=he.computeCartesianToProj(Pe),pe&&(Pe.z=0)),ae[be]=new n.Cartesian2(Ce,Ne),oe[be]=ve,de[be]=Pe,g&&(se[be]=(I.WebMercatorProjection.geodeticLatitudeToMercatorAngle(V.latitude)-K)*Q),o.Matrix4.multiplyByPoint($,Pe,B),r.Cartesian3.minimumByComponent(B,ue,ue),r.Cartesian3.maximumByComponent(B,ce,ce)}var Ae=Y(t.westIndices,(function(e,t){return ae[e].y-ae[t].y})),we=Y(t.eastIndices,(function(e,t){return ae[t].y-ae[e].y})),Se=Y(t.southIndices,(function(e,t){return ae[t].x-ae[e].x})),Be=Y(t.northIndices,(function(e,t){return ae[e].x-ae[t].x})),Ee=1e-4*(fe-me),Fe=1e-4*(Ie-ge),Ve=-Ee,Le=Ee,We=Fe,De=-Fe,Ge=de.length,ke=X;ke=Math.min(ke,z(Ae,de,oe,ae,ee,se,U,_,t.westSkirtHeight,Ve,0,he)),ke=Math.min(ke,z(Se,de,oe,ae,ee,se,U,_,t.southSkirtHeight,0,De,he)),ke=Math.min(ke,z(we,de,oe,ae,ee,se,U,_,t.eastSkirtHeight,Le,0,he)),ke=Math.min(ke,z(Be,de,oe,ae,ee,se,U,_,t.northSkirtHeight,0,We,he));for(var ze,Ye,_e,Oe=le.length,je=3*Math.max(0,2*(f-4)),He=0;He<je;He++)le.push(0);A.TerrainProvider.addSkirtIndices(Ae,Se,we,Be,l,le,Oe),1!==q&&(Ye=i.BoundingSphere.fromPoints(de),ze=M.OrientedBoundingBox.fromRectangle(_,X,Z,U)),(1!==q||X<0)&&(_e=new P.EllipsoidalOccluder(U).computeHorizonCullingPointPossiblyUnderEllipsoid(J,de,X));const Re=[];var Ue=(e,t)=>{let r=new v.emMod.LBSpaSerial;r.WriteTriangle(t);let n=new Uint8Array(r.GetBufferSize());for(let i=0;i<n.length;++i)n[i]=r.GetBufferVal(i);v.emMod.destroy(r),Re.push({serial:n,fileName:e})},qe=(t,r,n)=>{let i=e.defaultValue(n,0),a=new v.emMod.LBSpaTriangle;a.SetPtNum(t.length,!1,!1);for(let e=0;e<t.length;e++){const r=t[e];a.SetPtVal(e,r.x,r.y,r.z)}a.SetIndexNum(r.length);for(let e=0;e<r.length;e++)a.SetIndexVal(e,r[e]);N&&Ue(i>0?"ter2.tri":"hole2.tri",a);let o=new v.emMod.LBSpaBody;return o.Init(a,i),v.emMod.destroy(a),o};let Xe=!1;if(x&&(Xe=(()=>{let t,i=!1;const a=y.AxisAlignedBoundingBox.fromPoints(de);for(let e=0;e<p.length;e++){let r=[],n=[];w.BorderInfo.clone(p[e]).createTriangle(r,n);const o=y.AxisAlignedBoundingBox.fromPoints(r);if(!a.isOverlap(o))continue;void 0===t&&(t=qe(de,le,Oe));let d=qe(r,n);t.CheckReference(d)&&t.ComputeDifference(d)?(v.emMod.destroy(d),i=!0):v.emMod.destroy(d)}return i&&(t=>{de.length=0,le.length=0,ae.length=0,oe.length=0,g&&(se.length=0),ie&&(ee.length=0,ie=!1);let i=new v.emMod.LBSpaTriangle,a=new v.emMod.LBSpaSkirtInfo;t.GetTriangle(i,a);let o=i.GetPtNum(),d=i.GetIndexNum();if(o<3||d<3)return v.emMod.destroy(i),void v.emMod.destroy(a);Ge=a.iPtSectIndex,Oe=a.iIndexSectIndex;for(let s=0;s<o;s++){let t=i.GetPt(s),a=new r.Cartesian3(t.x,t.y,t.z);de.push(a),e.defined(he)?(he.computeProjToDegree(a,!0,B),n.Cartographic.fromDegrees(B.x,B.y,B.z,V)):U.cartesianToCartographic(a,V);let o=new n.Cartesian2((V.longitude-O)/(H-O),(V.latitude-j)/(R-j));ae.push(o),oe.push(V.height),g&&se.push((I.WebMercatorProjection.geodeticLatitudeToMercatorAngle(V.latitude)-K)*Q)}for(let e=0;e<d;e++)le.push(i.GetIndex(e));v.emMod.destroy(i),v.emMod.destroy(a)})(t),void 0!==t&&v.emMod.destroy(t),i})(),de.length<3))return{holeAllData:!0};for(var Ze=new y.AxisAlignedBoundingBox(ue,ce,J),Je=new P.TerrainEncoding(Ze,ke,Z,u,ie,g),Ke=Je.getStride(),Qe=de.length*Ke,$e=new Float32Array(Qe),et=0,tt=0;tt<de.length;++tt){if(ie){var rt=2*tt;if(L.x=ee[rt],L.y=ee[rt+1],1!==q){var nt=h.AttributeCompression.octDecode(L.x,L.y,W),it=a.Transforms.eastNorthUpToFixedFrame(de[tt],U,G),at=o.Matrix4.inverseTransformation(it,D);o.Matrix4.multiplyByPointAsVector(at,nt,nt),nt.z*=q,r.Cartesian3.normalize(nt,nt),o.Matrix4.multiplyByPointAsVector(it,nt,nt),r.Cartesian3.normalize(nt,nt),h.AttributeCompression.octEncode(nt,L)}}et=Je.encode($e,et,de[tt],ae[tt],oe[tt],L,se[tt])}var ot,dt=m.IndexDatatype.createTypedArray(de.length,le.length);return dt.set(le,0),k?(ot=C.CreatePhysicalArray.createPhysicalArrayFromTerrain(v.emMod,S,t.relativeToCenter,de,le),d.push($e.buffer,dt.buffer,ot.buffer)):d.push($e.buffer,dt.buffer),e.defined(he)&&he.destroy(),{vertices:$e.buffer,indices:dt.buffer,vertexStride:Ke,center:J,minimumHeight:X,maximumHeight:Z,boundingSphere:Ye,orientedBoundingBox:ze,occludeePointInScaledSpace:_e,encoding:Je,indexCountWithoutSkirts:Oe,vertexCountWithoutSkirts:Ge,vertexCount:de.length,physicalArray:ot,downloadAry:Re,haveDiff:Xe}}function z(t,n,i,a,o,d,s,l,u,c,h,m){var f=e.defined(o),g=d.length>0,I=Number.POSITIVE_INFINITY,p=l.north,y=l.south,T=l.east,M=l.west;T<M&&(T+=r.CesiumMath.TWO_PI);for(var x=t.length,b=0;b<x;++b){var C=t[b],N=i[C],v=a[C];V.longitude=r.CesiumMath.lerp(M,T,v.x)+c,V.latitude=r.CesiumMath.lerp(y,p,v.y)+h,V.height=N-u;var P=s.cartographicToCartesian(V,B);if(e.defined(m)&&(P=m.computeCartesianToProj(P)),n.push(P),a.push(v),i.push(V.height),f){var A=2*C;o.push(o[A]),o.push(o[A+1])}if(g){var w=d[C];d.push(w)}I=Math.min(I,V.height)}return I}function Y(t,r){var n;return"function"==typeof t.slice&&"function"!=typeof(n=t.slice()).sort&&(n=void 0),e.defined(n)||(n=Array.prototype.slice.call(t)),n.sort(r),n}return function(t){var r=t.data.webAssemblyConfig;e.defined(r)&&v.EmWrapperManager.initWebAssembly(r.wasmBinaryFileES6).then((function(){S=new v.emMod.LBSpaMgr,self.onmessage=p(k),self.postMessage(!0)}))}}));