define(["./when-45f3d25d","./Check-34538dad","./Cartesian3-eab74dc0","./Cartesian2-174fefc1","./BoundingSphere-9db3442e","./Transforms-3e7152f2","./Matrix4-22b96d31","./RuntimeError-86da6af2","./WebGLConstants-3660bc8f","./ComponentDatatype-86703c58","./GeometryAttribute-98a8cf59","./PrimitiveType-30fa6f85","./AttributeCompression-6e02a904","./IndexDatatype-cb635cbc","./IntersectionTests-4fa5e272","./Plane-99a0ae01","./WebMercatorProjection-2349e1e4","./createTaskProcessorWorker","./AxisAlignedBoundingBox-1aaa0e65","./EllipsoidTangentPlane-a1163ec8","./OrientedBoundingBox-b28ad40e","./EllipsoidRhumbLine-de5cdc57","./PolygonPipeline-05839d65","./CreatePhysicalArray-c5e20c39","./materem-cccd3124","./EmWrapperManager-83011cae","./TerrainEncoding-a14495f9","./TerrainProvider-a55e11c7","./EmLBDeal-3bb2b5fa"],(function(e,t,r,n,i,a,o,d,s,l,u,c,h,m,g,f,I,p,y,T,M,x,C,v,b,N,P,A,w){"use strict";var S,B=32767,E=new r.Cartesian3,F=new r.Cartesian3,V=new r.Cartesian3,W=new n.Cartographic,D=new n.Cartesian2,L=new r.Cartesian3,k=new o.Matrix4,G=new o.Matrix4;function Y(t,d){var s=t.quantizedVertices,l=s.length/3;if(l<3)return{holeAllData:!0};var u,c=t.octEncodedNormals,g=t.westIndices.length+t.eastIndices.length+t.southIndices.length+t.northIndices.length,f=t.includeWebMercatorT,p=t.holeAry,T=t.planishBorderInfoAry,x=e.defined(p)&&p.length>0,C=e.defined(T)&&T.length>0,b=(t.tileInfo,n.Rectangle.clone(t.rectangle)),Y=b.west,O=b.south,j=b.east,H=b.north,R=n.Ellipsoid.clone(t.ellipsoid),U=t.exaggeration,q=t.minimumHeight*U,X=t.maximumHeight*U,Z=t.relativeToCenter;u=t.isPlaneMode?o.Matrix4.fromTranslation(Z):a.Transforms.eastNorthUpToFixedFrame(Z,R);var J,K,Q=o.Matrix4.inverseTransformation(u,new o.Matrix4);f&&(J=I.WebMercatorProjection.geodeticLatitudeToMercatorAngle(O),K=1/(I.WebMercatorProjection.geodeticLatitudeToMercatorAngle(H)-J));var $,ee=s.subarray(0,l),te=s.subarray(l,2*l),re=s.subarray(2*l,3*l),ne=e.defined(c),ie=new Array(l),ae=new Array(l),oe=new Array(l),de=f?new Array(l):[];ne&&($=[...c]);var se=[...t.indices],le=F;le.x=Number.POSITIVE_INFINITY,le.y=Number.POSITIVE_INFINITY,le.z=Number.POSITIVE_INFINITY;var ue=V;ue.x=Number.NEGATIVE_INFINITY,ue.y=Number.NEGATIVE_INFINITY,ue.z=Number.NEGATIVE_INFINITY;var ce,he=Number.POSITIVE_INFINITY,me=Number.NEGATIVE_INFINITY,ge=Number.POSITIVE_INFINITY,fe=Number.NEGATIVE_INFINITY,Ie=!1;if(t.isPlaneMode){var pe=t.projectionString,ye=t.dCenX,Te=t.dCenY,Me=t.dCenZ;ce=new w.EmLBDeal;var xe=ce.init(pe,new r.Cartesian3(ye,Te,Me));xe?C&&ce.setPlanishBorderInfoAry(T):(ce.destroy(),ce=void 0),Ie=t.isDefaultTer}for(var Ce=0;Ce<l;++Ce){var ve=ee[Ce],be=te[Ce],Ne=ve/B,Pe=be/B,Ae=r.CesiumMath.lerp(q,X,re[Ce]/B);W.longitude=r.CesiumMath.lerp(Y,j,Ne),W.latitude=r.CesiumMath.lerp(O,H,Pe),W.height=Ae,he=Math.min(W.longitude,he),me=Math.max(W.longitude,me),ge=Math.min(W.latitude,ge),fe=Math.max(W.latitude,fe);var we=R.cartographicToCartesian(W);e.defined(ce)&&(we=ce.computeCartesianToProj(we),Ie&&(we.z=0)),ie[Ce]=new n.Cartesian2(Ne,Pe),ae[Ce]=Ae,oe[Ce]=we,f&&(de[Ce]=(I.WebMercatorProjection.geodeticLatitudeToMercatorAngle(W.latitude)-J)*K),o.Matrix4.multiplyByPoint(Q,we,E),r.Cartesian3.minimumByComponent(E,le,le),r.Cartesian3.maximumByComponent(E,ue,ue)}var Se=z(t.westIndices,(function(e,t){return ie[e].y-ie[t].y})),Be=z(t.eastIndices,(function(e,t){return ie[t].y-ie[e].y})),Ee=z(t.southIndices,(function(e,t){return ie[t].x-ie[e].x})),Fe=z(t.northIndices,(function(e,t){return ie[e].x-ie[t].x})),Ve=1e-4,We=(me-he)*Ve,De=(fe-ge)*Ve,Le=-We,ke=0,Ge=We,Ye=0,_e=0,ze=De,Oe=0,je=-De,He=oe.length,Re=q;Re=Math.min(Re,_(Se,oe,ae,ie,$,de,R,b,t.westSkirtHeight,Le,ke,ce)),Re=Math.min(Re,_(Ee,oe,ae,ie,$,de,R,b,t.southSkirtHeight,Oe,je,ce)),Re=Math.min(Re,_(Be,oe,ae,ie,$,de,R,b,t.eastSkirtHeight,Ge,Ye,ce)),Re=Math.min(Re,_(Fe,oe,ae,ie,$,de,R,b,t.northSkirtHeight,_e,ze,ce));for(var Ue,qe,Xe,Ze=se.length,Je=3*Math.max(0,2*(g-4)),Ke=0;Ke<Je;Ke++)se.push(0);if(A.TerrainProvider.addSkirtIndices(Se,Ee,Be,Fe,l,se,Ze),1!==U&&(qe=i.BoundingSphere.fromPoints(oe),Ue=M.OrientedBoundingBox.fromRectangle(b,q,X,R)),1!==U||q<0){var Qe=new P.EllipsoidalOccluder(R);Xe=Qe.computeHorizonCullingPointPossiblyUnderEllipsoid(Z,oe,q)}const $e=[];var et=(t,r,n)=>{let i=e.defaultValue(n,0),a=new N.emMod.LBSpaTriangle;a.SetPtNum(t.length,!1,!1);for(let e=0;e<t.length;e++){const r=t[e];a.SetPtVal(e,r.x,r.y,r.z)}a.SetIndexNum(r.length);for(let e=0;e<r.length;e++)a.SetIndexVal(e,r[e]);let o=new N.emMod.LBSpaBody;return o.Init(a,i),N.emMod.destroy(a),o},tt=t=>{oe.length=0,se.length=0,ie.length=0,ae.length=0,f&&(de.length=0),ne&&($.length=0,ne=!1);let i=new N.emMod.LBSpaTriangle,a=new N.emMod.LBSpaSkirtInfo;t.GetTriangle(i,a);let o=i.GetPtNum(),d=i.GetIndexNum();if(o<3||d<3)return N.emMod.destroy(i),void N.emMod.destroy(a);He=a.iPtSectIndex,Ze=a.iIndexSectIndex;for(let s=0;s<o;s++){let t=i.GetPt(s),a=new r.Cartesian3(t.x,t.y,t.z);oe.push(a),e.defined(ce)?(ce.computeProjToDegree(a,!0,E),n.Cartographic.fromDegrees(E.x,E.y,E.z,W)):R.cartesianToCartographic(a,W);let o=new n.Cartesian2((W.longitude-Y)/(j-Y),(W.latitude-O)/(H-O));ie.push(o),ae.push(W.height),f&&de.push((I.WebMercatorProjection.geodeticLatitudeToMercatorAngle(W.latitude)-J)*K)}for(let e=0;e<d;e++)se.push(i.GetIndex(e));N.emMod.destroy(i),N.emMod.destroy(a)},rt=()=>{let e,t=!1;const r=y.AxisAlignedBoundingBox.fromPoints(oe);for(let n=0;n<p.length;n++){const i=w.BorderInfo.clone(p[n]);let a=[],o=[];i.createTriangle(a,o);const d=y.AxisAlignedBoundingBox.fromPoints(a);if(!r.isOverlap(d))continue;void 0===e&&(e=et(oe,se,Ze));let s=et(a,o);e.CheckReference(s)?e.ComputeDifference(s)?(N.emMod.destroy(s),t=!0):N.emMod.destroy(s):N.emMod.destroy(s)}return t&&tt(e),void 0!==e&&N.emMod.destroy(e),t};let nt=!1;if(x&&(nt=rt(),oe.length<3))return{holeAllData:!0};for(var it=new y.AxisAlignedBoundingBox(le,ue,Z),at=new P.TerrainEncoding(it,Re,X,u,ne,f),ot=at.getStride(),dt=oe.length*ot,st=new Float32Array(dt),lt=0,ut=0;ut<oe.length;++ut){if(ne){var ct=2*ut;if(D.x=$[ct],D.y=$[ct+1],1!==U){var ht=h.AttributeCompression.octDecode(D.x,D.y,L),mt=a.Transforms.eastNorthUpToFixedFrame(oe[ut],R,G),gt=o.Matrix4.inverseTransformation(mt,k);o.Matrix4.multiplyByPointAsVector(gt,ht,ht),ht.z*=U,r.Cartesian3.normalize(ht,ht),o.Matrix4.multiplyByPointAsVector(mt,ht,ht),r.Cartesian3.normalize(ht,ht),h.AttributeCompression.octEncode(ht,D)}}lt=at.encode(st,lt,oe[ut],ie[ut],ae[ut],D,de[ut])}var ft=m.IndexDatatype.createTypedArray(oe.length,se.length);ft.set(se,0);var It=v.CreatePhysicalArray.createPhysicalArrayFromTerrain(N.emMod,S,t.relativeToCenter,oe,se);return d.push(st.buffer,ft.buffer,It.buffer),e.defined(ce)&&ce.destroy(),{vertices:st.buffer,indices:ft.buffer,vertexStride:ot,center:Z,minimumHeight:q,maximumHeight:X,boundingSphere:qe,orientedBoundingBox:Ue,occludeePointInScaledSpace:Xe,encoding:at,indexCountWithoutSkirts:Ze,vertexCountWithoutSkirts:He,vertexCount:oe.length,physicalArray:It,downloadAry:$e,haveDiff:nt}}function _(t,n,i,a,o,d,s,l,u,c,h,m){var g=e.defined(o),f=d.length>0,I=Number.POSITIVE_INFINITY,p=l.north,y=l.south,T=l.east,M=l.west;T<M&&(T+=r.CesiumMath.TWO_PI);for(var x=t.length,C=0;C<x;++C){var v=t[C],b=i[v],N=a[v];W.longitude=r.CesiumMath.lerp(M,T,N.x)+c,W.latitude=r.CesiumMath.lerp(y,p,N.y)+h,W.height=b-u;var P=s.cartographicToCartesian(W,E);if(e.defined(m)&&(P=m.computeCartesianToProj(P)),n.push(P),a.push(N),i.push(W.height),g){var A=2*v;o.push(o[A]),o.push(o[A+1])}if(f){var w=d[v];d.push(w)}I=Math.min(I,W.height)}return I}function z(t,r){var n;return"function"===typeof t.slice&&(n=t.slice(),"function"!==typeof n.sort&&(n=void 0)),e.defined(n)||(n=Array.prototype.slice.call(t)),n.sort(r),n}function O(t){var r=t.data,n=r.webAssemblyConfig;e.defined(n)&&N.EmWrapperManager.initWebAssembly(n.wasmBinaryFileES6).then((function(){S=new N.emMod.LBSpaMgr,self.onmessage=p(Y),self.postMessage(!0)}))}return O}));