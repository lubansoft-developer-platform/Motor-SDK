define(["./when-45f3d25d","./Check-34538dad","./Cartesian3-eab74dc0","./Cartesian2-174fefc1","./BoundingSphere-37359cf8","./Transforms-6b57162d","./Matrix4-ed224189","./RuntimeError-86da6af2","./WebGLConstants-3660bc8f","./ComponentDatatype-86703c58","./GeometryAttribute-b1ed7c2e","./PrimitiveType-30fa6f85","./AttributeCompression-6e02a904","./IndexDatatype-cb635cbc","./IntersectionTests-a310845d","./Plane-87957166","./WebMercatorProjection-2349e1e4","./createTaskProcessorWorker","./AxisAlignedBoundingBox-804b7aeb","./EllipsoidTangentPlane-37f60f7a","./OrientedBoundingBox-f9a274cd","./EllipsoidRhumbLine-de5cdc57","./PolygonPipeline-b585c3c1","./CreatePhysicalArray-62163d3f","./materem-cccd3124","./EmWrapperManager-83011cae","./TerrainEncoding-2d0e3daf","./TerrainProvider-a55e11c7","./EmLBDeal-9210927a"],(function(e,t,r,n,i,a,o,d,s,l,u,c,h,m,g,f,I,p,y,T,M,x,C,v,b,N,A,P,w){"use strict";var S,B=32767,E=new r.Cartesian3,F=new r.Cartesian3,V=new r.Cartesian3,L=new n.Cartographic,W=new n.Cartesian2,D=new r.Cartesian3,G=new o.Matrix4,k=new o.Matrix4;function z(t,d){var s=t.quantizedVertices,l=s.length/3;if(l<3)return{holeAllData:!0};var u,c=t.octEncodedNormals,g=t.westIndices.length+t.eastIndices.length+t.southIndices.length+t.northIndices.length,f=t.includeWebMercatorT,p=t.holeAry,T=t.planishBorderInfoAry,x=e.defined(p)&&p.length>0,C=e.defined(T)&&T.length>0,b=(t.tileInfo,t.needDownLoad),z=n.Rectangle.clone(t.rectangle),O=z.west,j=z.south,H=z.east,R=z.north,U=n.Ellipsoid.clone(t.ellipsoid),q=t.exaggeration,X=t.minimumHeight*q,Z=t.maximumHeight*q,J=t.relativeToCenter;u=t.isPlaneMode?o.Matrix4.fromTranslation(J):a.Transforms.eastNorthUpToFixedFrame(J,U);var K,Q,$=o.Matrix4.inverseTransformation(u,new o.Matrix4);f&&(K=I.WebMercatorProjection.geodeticLatitudeToMercatorAngle(j),Q=1/(I.WebMercatorProjection.geodeticLatitudeToMercatorAngle(R)-K));var ee,te=s.subarray(0,l),re=s.subarray(l,2*l),ne=s.subarray(2*l,3*l),ie=e.defined(c),ae=new Array(l),oe=new Array(l),de=new Array(l),se=f?new Array(l):[];ie&&(ee=[...c]);var le=[...t.indices],ue=F;ue.x=Number.POSITIVE_INFINITY,ue.y=Number.POSITIVE_INFINITY,ue.z=Number.POSITIVE_INFINITY;var ce=V;ce.x=Number.NEGATIVE_INFINITY,ce.y=Number.NEGATIVE_INFINITY,ce.z=Number.NEGATIVE_INFINITY;var he,me=Number.POSITIVE_INFINITY,ge=Number.NEGATIVE_INFINITY,fe=Number.POSITIVE_INFINITY,Ie=Number.NEGATIVE_INFINITY,pe=!1;if(t.isPlaneMode){var ye=t.projectionString,Te=t.dCenX,Me=t.dCenY,xe=t.dCenZ;he=new w.EmLBDeal;var Ce=he.init(ye,new r.Cartesian3(Te,Me,xe));Ce?C&&he.setPlanishBorderInfoAry(T):(he.destroy(),he=void 0),pe=t.isDefaultTer}for(var ve=0;ve<l;++ve){var be=te[ve],Ne=re[ve],Ae=be/B,Pe=Ne/B,we=r.CesiumMath.lerp(X,Z,ne[ve]/B);L.longitude=r.CesiumMath.lerp(O,H,Ae),L.latitude=r.CesiumMath.lerp(j,R,Pe),L.height=we,me=Math.min(L.longitude,me),ge=Math.max(L.longitude,ge),fe=Math.min(L.latitude,fe),Ie=Math.max(L.latitude,Ie);var Se=U.cartographicToCartesian(L);e.defined(he)&&(Se=he.computeCartesianToProj(Se),pe&&(Se.z=0)),ae[ve]=new n.Cartesian2(Ae,Pe),oe[ve]=we,de[ve]=Se,f&&(se[ve]=(I.WebMercatorProjection.geodeticLatitudeToMercatorAngle(L.latitude)-K)*Q),o.Matrix4.multiplyByPoint($,Se,E),r.Cartesian3.minimumByComponent(E,ue,ue),r.Cartesian3.maximumByComponent(E,ce,ce)}var Be=_(t.westIndices,(function(e,t){return ae[e].y-ae[t].y})),Ee=_(t.eastIndices,(function(e,t){return ae[t].y-ae[e].y})),Fe=_(t.southIndices,(function(e,t){return ae[t].x-ae[e].x})),Ve=_(t.northIndices,(function(e,t){return ae[e].x-ae[t].x})),Le=1e-4,We=(ge-me)*Le,De=(Ie-fe)*Le,Ge=-We,ke=0,ze=We,Ye=0,_e=0,Oe=De,je=0,He=-De,Re=de.length,Ue=X;Ue=Math.min(Ue,Y(Be,de,oe,ae,ee,se,U,z,t.westSkirtHeight,Ge,ke,he)),Ue=Math.min(Ue,Y(Fe,de,oe,ae,ee,se,U,z,t.southSkirtHeight,je,He,he)),Ue=Math.min(Ue,Y(Ee,de,oe,ae,ee,se,U,z,t.eastSkirtHeight,ze,Ye,he)),Ue=Math.min(Ue,Y(Ve,de,oe,ae,ee,se,U,z,t.northSkirtHeight,_e,Oe,he));for(var qe,Xe,Ze,Je=le.length,Ke=3*Math.max(0,2*(g-4)),Qe=0;Qe<Ke;Qe++)le.push(0);if(P.TerrainProvider.addSkirtIndices(Be,Fe,Ee,Ve,l,le,Je),1!==q&&(Xe=i.BoundingSphere.fromPoints(de),qe=M.OrientedBoundingBox.fromRectangle(z,X,Z,U)),1!==q||X<0){var $e=new A.EllipsoidalOccluder(U);Ze=$e.computeHorizonCullingPointPossiblyUnderEllipsoid(J,de,X)}const et=[];var tt=(e,t)=>{let r=new N.emMod.LBSpaSerial;r.WriteTriangle(t);let n=new Uint8Array(r.GetBufferSize());for(let i=0;i<n.length;++i)n[i]=r.GetBufferVal(i);N.emMod.destroy(r),et.push({serial:n,fileName:e})},rt=(t,r,n)=>{let i=e.defaultValue(n,0),a=new N.emMod.LBSpaTriangle;a.SetPtNum(t.length,!1,!1);for(let e=0;e<t.length;e++){const r=t[e];a.SetPtVal(e,r.x,r.y,r.z)}a.SetIndexNum(r.length);for(let e=0;e<r.length;e++)a.SetIndexVal(e,r[e]);b&&tt(i>0?"ter2.tri":"hole2.tri",a);let o=new N.emMod.LBSpaBody;return o.Init(a,i),N.emMod.destroy(a),o},nt=t=>{de.length=0,le.length=0,ae.length=0,oe.length=0,f&&(se.length=0),ie&&(ee.length=0,ie=!1);let i=new N.emMod.LBSpaTriangle,a=new N.emMod.LBSpaSkirtInfo;t.GetTriangle(i,a);let o=i.GetPtNum(),d=i.GetIndexNum();if(o<3||d<3)return N.emMod.destroy(i),void N.emMod.destroy(a);Re=a.iPtSectIndex,Je=a.iIndexSectIndex;for(let s=0;s<o;s++){let t=i.GetPt(s),a=new r.Cartesian3(t.x,t.y,t.z);de.push(a),e.defined(he)?(he.computeProjToDegree(a,!0,E),n.Cartographic.fromDegrees(E.x,E.y,E.z,L)):U.cartesianToCartographic(a,L);let o=new n.Cartesian2((L.longitude-O)/(H-O),(L.latitude-j)/(R-j));ae.push(o),oe.push(L.height),f&&se.push((I.WebMercatorProjection.geodeticLatitudeToMercatorAngle(L.latitude)-K)*Q)}for(let e=0;e<d;e++)le.push(i.GetIndex(e));N.emMod.destroy(i),N.emMod.destroy(a)},it=()=>{let e,t=!1;const r=y.AxisAlignedBoundingBox.fromPoints(de);for(let n=0;n<p.length;n++){const i=w.BorderInfo.clone(p[n]);let a=[],o=[];i.createTriangle(a,o);const d=y.AxisAlignedBoundingBox.fromPoints(a);if(!r.isOverlap(d))continue;void 0===e&&(e=rt(de,le,Je));let s=rt(a,o);e.CheckReference(s)?e.ComputeDifference(s)?(N.emMod.destroy(s),t=!0):N.emMod.destroy(s):N.emMod.destroy(s)}return t&&nt(e),void 0!==e&&N.emMod.destroy(e),t};let at=!1;if(x&&(at=it(),de.length<3))return{holeAllData:!0};for(var ot=new y.AxisAlignedBoundingBox(ue,ce,J),dt=new A.TerrainEncoding(ot,Ue,Z,u,ie,f),st=dt.getStride(),lt=de.length*st,ut=new Float32Array(lt),ct=0,ht=0;ht<de.length;++ht){if(ie){var mt=2*ht;if(W.x=ee[mt],W.y=ee[mt+1],1!==q){var gt=h.AttributeCompression.octDecode(W.x,W.y,D),ft=a.Transforms.eastNorthUpToFixedFrame(de[ht],U,k),It=o.Matrix4.inverseTransformation(ft,G);o.Matrix4.multiplyByPointAsVector(It,gt,gt),gt.z*=q,r.Cartesian3.normalize(gt,gt),o.Matrix4.multiplyByPointAsVector(ft,gt,gt),r.Cartesian3.normalize(gt,gt),h.AttributeCompression.octEncode(gt,W)}}ct=dt.encode(ut,ct,de[ht],ae[ht],oe[ht],W,se[ht])}var pt=m.IndexDatatype.createTypedArray(de.length,le.length);pt.set(le,0);var yt=v.CreatePhysicalArray.createPhysicalArrayFromTerrain(N.emMod,S,t.relativeToCenter,de,le);return d.push(ut.buffer,pt.buffer,yt.buffer),e.defined(he)&&he.destroy(),{vertices:ut.buffer,indices:pt.buffer,vertexStride:st,center:J,minimumHeight:X,maximumHeight:Z,boundingSphere:Xe,orientedBoundingBox:qe,occludeePointInScaledSpace:Ze,encoding:dt,indexCountWithoutSkirts:Je,vertexCountWithoutSkirts:Re,vertexCount:de.length,physicalArray:yt,downloadAry:et,haveDiff:at}}function Y(t,n,i,a,o,d,s,l,u,c,h,m){var g=e.defined(o),f=d.length>0,I=Number.POSITIVE_INFINITY,p=l.north,y=l.south,T=l.east,M=l.west;T<M&&(T+=r.CesiumMath.TWO_PI);for(var x=t.length,C=0;C<x;++C){var v=t[C],b=i[v],N=a[v];L.longitude=r.CesiumMath.lerp(M,T,N.x)+c,L.latitude=r.CesiumMath.lerp(y,p,N.y)+h,L.height=b-u;var A=s.cartographicToCartesian(L,E);if(e.defined(m)&&(A=m.computeCartesianToProj(A)),n.push(A),a.push(N),i.push(L.height),g){var P=2*v;o.push(o[P]),o.push(o[P+1])}if(f){var w=d[v];d.push(w)}I=Math.min(I,L.height)}return I}function _(t,r){var n;return"function"===typeof t.slice&&(n=t.slice(),"function"!==typeof n.sort&&(n=void 0)),e.defined(n)||(n=Array.prototype.slice.call(t)),n.sort(r),n}function O(t){var r=t.data,n=r.webAssemblyConfig;e.defined(n)&&N.EmWrapperManager.initWebAssembly(n.wasmBinaryFileES6).then((function(){S=new N.emMod.LBSpaMgr,self.onmessage=p(z),self.postMessage(!0)}))}return O}));