define(["./when-45f3d25d","./Check-34538dad","./Cartesian3-e69091b9","./Cartesian2-7a44370a","./BoundingSphere-bacc5cb6","./Matrix4-c65e6a1b","./RuntimeError-86da6af2","./Rectangle-c7d55cfa","./WebGLConstants-3660bc8f","./ComponentDatatype-86703c58","./GeometryAttribute-70b679fd","./PrimitiveType-30fa6f85","./Transforms-7d49a8ab","./AttributeCompression-1e177d5e","./IndexDatatype-e52361bd","./IntersectionTests-8855da40","./Plane-1875afb4","./WebMercatorProjection-c32b7757","./createTaskProcessorWorker","./EllipsoidTangentPlane-3e14dd4d","./OrientedBoundingBox-c5c382aa","./EllipsoidRhumbLine-4bc7760a","./PolygonPipeline-d22f3330","./CreatePhysicalArray-d462d0a0","./materem-f017d2c3","./EmWrapperManager-a482472d","./TerrainEncoding-eef38e10","./TerrainProvider-00be0263","./EmLBDeal-8c054e74"],(function(e,t,r,n,i,a,o,s,d,l,h,u,c,g,m,p,f,y,I,x,M,T,A,C,P,b,v,N,_){"use strict";class w{constructor(){this._modelMatrix=a.Matrix4.IDENTITY.clone(),this._pt2DAry=[],this._under=0,this._height=0}static clone(e){const t=a.Matrix4.fromArray(e._modelMatrix),r=e._under,i=e._height,o=[];e._pt2DAry.forEach((e=>{o.push(new n.Cartesian2(e.x,e.y))}));const s=new w;return s._under=r,s._height=i,s._pt2DAry=o,s._modelMatrix=t,s}getBoundingbox(){const e=[];return this.getPtAry(!0,e),this.getPtAry(!1,e),x.AxisAlignedBoundingBox.fromPoints(e)}createTriangle(e,t){let r=e.length;this.getPtAry(!0,e);let n=e.length-r;this.getPtAry(!1,e);let i=0;for(let o=0;o<n;o++)i=o===n-1?0:o+1,t.push(r+o),t.push(r+i),t.push(r+n+i),t.push(r+o),t.push(r+n+i),t.push(r+n+o);const a=A.PolygonPipeline.triangulate(this._pt2DAry);t.push(...a.map((e=>r+n+e))),t.push(...a.reverse().map((e=>r+e)))}set modelMatrix(e){this._modelMatrix=e.clone()}get modelMatrix(){return this._modelMatrix}set pt2DAry(t){this._pt2DAry=e.defaultValue(t,[]),this._pt2DAry.length>2&&A.PolygonPipeline.computeWindingOrder2D(this._pt2DAry)===A.WindingOrder.CLOCKWISE&&this._pt2DAry.reverse()}get pt2DAry(){return this._pt2DAry}set under(e){this._under=e}get under(){return this._under}set height(e){this._height=e}get height(){return this._height}getPtAry(e,t){this._pt2DAry.forEach((n=>{let i=new r.Cartesian3(n.x,n.y,this._under);e||(i.z+=this._height),a.Matrix4.multiplyByPoint(this._modelMatrix,i,i),t.push(i)}))}}var E,S=32767,B=new r.Cartesian3,D=new r.Cartesian3,F=new r.Cartesian3,V=new n.Cartographic,W=new n.Cartesian2,L=new r.Cartesian3,O=new a.Matrix4,Y=new a.Matrix4;function k(t,o){var d=t.quantizedVertices,l=d.length/3;if(l<3)return{holeAllData:!0};var h,u=t.octEncodedNormals,p=t.westIndices.length+t.eastIndices.length+t.southIndices.length+t.northIndices.length,f=t.includeWebMercatorT,I=t.holeAry,T=e.defined(I)&&I.length>0,A=(t.tileInfo,s.Rectangle.clone(t.rectangle)),P=A.west,k=A.south,j=A.east,H=A.north,R=n.Ellipsoid.clone(t.ellipsoid),U=t.exaggeration,q=t.minimumHeight*U,K=t.maximumHeight*U,X=t.relativeToCenter;h=t.isPlaneMode?a.Matrix4.fromTranslation(X):c.Transforms.eastNorthUpToFixedFrame(X,R);var Z,J,Q=a.Matrix4.inverseTransformation(h,new a.Matrix4);f&&(Z=y.WebMercatorProjection.geodeticLatitudeToMercatorAngle(k),J=1/(y.WebMercatorProjection.geodeticLatitudeToMercatorAngle(H)-Z));var $,ee=d.subarray(0,l),te=d.subarray(l,2*l),re=d.subarray(2*l,3*l),ne=e.defined(u),ie=new Array(l),ae=new Array(l),oe=new Array(l),se=f?new Array(l):[];ne&&($=[...u]);var de=[...t.indices],le=D;le.x=Number.POSITIVE_INFINITY,le.y=Number.POSITIVE_INFINITY,le.z=Number.POSITIVE_INFINITY;var he=F;he.x=Number.NEGATIVE_INFINITY,he.y=Number.NEGATIVE_INFINITY,he.z=Number.NEGATIVE_INFINITY;var ue,ce=Number.POSITIVE_INFINITY,ge=Number.NEGATIVE_INFINITY,me=Number.POSITIVE_INFINITY,pe=Number.NEGATIVE_INFINITY;if(t.isPlaneMode){var fe=t.projectionString,ye=t.dCenX,Ie=t.dCenY,xe=t.dCenZ;ue=new _.EmLBDeal;var Me=ue.init(fe,new r.Cartesian3(ye,Ie,xe));Me||(ue.destroy(),ue=void 0)}for(var Te=0;Te<l;++Te){var Ae=ee[Te],Ce=te[Te],Pe=Ae/S,be=Ce/S,ve=r.CesiumMath.lerp(q,K,re[Te]/S);V.longitude=r.CesiumMath.lerp(P,j,Pe),V.latitude=r.CesiumMath.lerp(k,H,be),V.height=ve,ce=Math.min(V.longitude,ce),ge=Math.max(V.longitude,ge),me=Math.min(V.latitude,me),pe=Math.max(V.latitude,pe);var Ne=R.cartographicToCartesian(V);e.defined(ue)&&(Ne=ue.computeCartesianToProj(Ne)),ie[Te]=new n.Cartesian2(Pe,be),ae[Te]=ve,oe[Te]=Ne,f&&(se[Te]=(y.WebMercatorProjection.geodeticLatitudeToMercatorAngle(V.latitude)-Z)*J),a.Matrix4.multiplyByPoint(Q,Ne,B),r.Cartesian3.minimumByComponent(B,le,le),r.Cartesian3.maximumByComponent(B,he,he)}var _e=z(t.westIndices,(function(e,t){return ie[e].y-ie[t].y})),we=z(t.eastIndices,(function(e,t){return ie[t].y-ie[e].y})),Ee=z(t.southIndices,(function(e,t){return ie[t].x-ie[e].x})),Se=z(t.northIndices,(function(e,t){return ie[e].x-ie[t].x})),Be=1e-4,De=(ge-ce)*Be,Fe=(pe-me)*Be,Ve=-De,We=0,Le=De,Oe=0,Ye=0,ke=Fe,Ge=0,ze=-Fe,je=oe.length,He=q;He=Math.min(He,G(_e,oe,ae,ie,$,se,R,A,t.westSkirtHeight,Ve,We,ue)),He=Math.min(He,G(Ee,oe,ae,ie,$,se,R,A,t.southSkirtHeight,Ge,ze,ue)),He=Math.min(He,G(we,oe,ae,ie,$,se,R,A,t.eastSkirtHeight,Le,Oe,ue)),He=Math.min(He,G(Se,oe,ae,ie,$,se,R,A,t.northSkirtHeight,Ye,ke,ue));for(var Re,Ue,qe,Ke=de.length,Xe=3*Math.max(0,2*(p-4)),Ze=0;Ze<Xe;Ze++)de.push(0);if(N.TerrainProvider.addSkirtIndices(_e,Ee,we,Se,l,de,Ke),1!==U&&(Ue=i.BoundingSphere.fromPoints(oe),Re=M.OrientedBoundingBox.fromRectangle(A,q,K,R)),1!==U||q<0){var Je=new v.EllipsoidalOccluder(R);qe=Je.computeHorizonCullingPointPossiblyUnderEllipsoid(X,oe,q)}const Qe=[];var $e=(t,r,n)=>{let i=e.defaultValue(n,0),a=new b.emMod.LBSpaTriangle;a.SetPtNum(t.length,!1,!1);for(let e=0;e<t.length;e++){const r=t[e];a.SetPtVal(e,r.x,r.y,r.z)}a.SetIndexNum(r.length);for(let e=0;e<r.length;e++)a.SetIndexVal(e,r[e]);let o=new b.emMod.LBSpaBody;return o.Init(a,i),b.emMod.destroy(a),o},et=t=>{oe.length=0,de.length=0,ie.length=0,ae.length=0,f&&(se.length=0),ne&&($.length=0,ne=!1);let i=new b.emMod.LBSpaTriangle,a=new b.emMod.LBSpaSkirtInfo;t.GetTriangle(i,a);let o=i.GetPtNum(),s=i.GetIndexNum();if(o<3||s<3)return b.emMod.destroy(i),void b.emMod.destroy(a);je=a.iPtSectIndex,Ke=a.iIndexSectIndex;for(let d=0;d<o;d++){let t=i.GetPt(d),a=new r.Cartesian3(t.x,t.y,t.z);oe.push(a),e.defined(ue)?(ue.computeProjToDegree(a,!0,B),n.Cartographic.fromDegrees(B.x,B.y,B.z,V)):R.cartesianToCartographic(a,V);let o=new n.Cartesian2((V.longitude-P)/(j-P),(V.latitude-k)/(H-k));ie.push(o),ae.push(V.height),f&&se.push((y.WebMercatorProjection.geodeticLatitudeToMercatorAngle(V.latitude)-Z)*J)}for(let e=0;e<s;e++)de.push(i.GetIndex(e));b.emMod.destroy(i),b.emMod.destroy(a)},tt=()=>{let e,t=!1;const r=x.AxisAlignedBoundingBox.fromPoints(oe);for(let n=0;n<I.length;n++){const i=w.clone(I[n]);let a=[],o=[];i.createTriangle(a,o);const s=x.AxisAlignedBoundingBox.fromPoints(a);if(!r.isOverlap(s))continue;void 0===e&&(e=$e(oe,de,Ke));let d=$e(a,o);e.CheckReference(d)?e.ComputeDifference(d)?(b.emMod.destroy(d),t=!0):b.emMod.destroy(d):b.emMod.destroy(d)}t&&et(e),void 0!==e&&b.emMod.destroy(e)};if(T&&(tt(),oe.length<3))return{holeAllData:!0};for(var rt=new x.AxisAlignedBoundingBox(le,he,X),nt=new v.TerrainEncoding(rt,He,K,h,ne,f),it=nt.getStride(),at=oe.length*it,ot=new Float32Array(at),st=0,dt=0;dt<oe.length;++dt){if(ne){var lt=2*dt;if(W.x=$[lt],W.y=$[lt+1],1!==U){var ht=g.AttributeCompression.octDecode(W.x,W.y,L),ut=c.Transforms.eastNorthUpToFixedFrame(oe[dt],R,Y),ct=a.Matrix4.inverseTransformation(ut,O);a.Matrix4.multiplyByPointAsVector(ct,ht,ht),ht.z*=U,r.Cartesian3.normalize(ht,ht),a.Matrix4.multiplyByPointAsVector(ut,ht,ht),r.Cartesian3.normalize(ht,ht),g.AttributeCompression.octEncode(ht,W)}}st=nt.encode(ot,st,oe[dt],ie[dt],ae[dt],W,se[dt])}var gt=m.IndexDatatype.createTypedArray(oe.length,de.length);gt.set(de,0);var mt=C.CreatePhysicalArray.createPhysicalArrayFromTerrain(b.emMod,E,t.relativeToCenter,oe,de);return o.push(ot.buffer,gt.buffer,mt.buffer),e.defined(ue)&&ue.destroy(),{vertices:ot.buffer,indices:gt.buffer,vertexStride:it,center:X,minimumHeight:q,maximumHeight:K,boundingSphere:Ue,orientedBoundingBox:Re,occludeePointInScaledSpace:qe,encoding:nt,indexCountWithoutSkirts:Ke,vertexCountWithoutSkirts:je,vertexCount:oe.length,physicalArray:mt,downloadAry:Qe}}function G(t,n,i,a,o,s,d,l,h,u,c,g){var m=e.defined(o),p=s.length>0,f=Number.POSITIVE_INFINITY,y=l.north,I=l.south,x=l.east,M=l.west;x<M&&(x+=r.CesiumMath.TWO_PI);for(var T=t.length,A=0;A<T;++A){var C=t[A],P=i[C],b=a[C];V.longitude=r.CesiumMath.lerp(M,x,b.x)+u,V.latitude=r.CesiumMath.lerp(I,y,b.y)+c,V.height=P-h;var v=d.cartographicToCartesian(V,B);if(e.defined(g)&&(v=g.computeCartesianToProj(v)),n.push(v),a.push(b),i.push(V.height),m){var N=2*C;o.push(o[N]),o.push(o[N+1])}if(p){var _=s[C];s.push(_)}f=Math.min(f,V.height)}return f}function z(t,r){var n;return"function"===typeof t.slice&&(n=t.slice(),"function"!==typeof n.sort&&(n=void 0)),e.defined(n)||(n=Array.prototype.slice.call(t)),n.sort(r),n}function j(t){var r=t.data,n=r.webAssemblyConfig;e.defined(n)&&b.EmWrapperManager.initWebAssembly(n.wasmBinaryFileES6).then((function(){E=new b.emMod.LBSpaMgr,self.onmessage=I(k),self.postMessage(!0)}))}return j}));