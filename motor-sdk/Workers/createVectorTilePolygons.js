define(["./when-45f3d25d","./Check-34538dad","./Cartesian3-e69091b9","./Cartesian2-7a44370a","./BoundingSphere-bacc5cb6","./Matrix4-c65e6a1b","./RuntimeError-86da6af2","./Rectangle-c7d55cfa","./WebGLConstants-3660bc8f","./Transforms-7d49a8ab","./AttributeCompression-1e177d5e","./IndexDatatype-e52361bd","./IntersectionTests-8855da40","./Plane-1875afb4","./createTaskProcessorWorker","./EllipsoidTangentPlane-3e14dd4d","./OrientedBoundingBox-c5c382aa","./Color-cbe4364d"],(function(e,a,r,n,t,i,o,s,d,f,c,u,h,l,g,p,b,v){"use strict";var C=new r.Cartesian3,y=new n.Ellipsoid,I=new s.Rectangle,m={min:void 0,max:void 0,indexBytesPerElement:void 0};function w(e){var a=new Float64Array(e),t=0;m.indexBytesPerElement=a[t++],m.min=a[t++],m.max=a[t++],r.Cartesian3.unpack(a,t,C),t+=r.Cartesian3.packedLength,n.Ellipsoid.unpack(a,t,y),t+=n.Ellipsoid.packedLength,s.Rectangle.unpack(a,t,I)}function x(e){for(var a=e.length,r=0,n=0;n<a;++n)r+=v.Color.packedLength+3+e[n].batchIds.length;return r}function A(e,a,r){var n=a.length,t=2+n*b.OrientedBoundingBox.packedLength+1+x(r),i=new Float64Array(t),o=0;i[o++]=e,i[o++]=n;for(var s=0;s<n;++s)b.OrientedBoundingBox.pack(a[s],i,o),o+=b.OrientedBoundingBox.packedLength;var d=r.length;i[o++]=d;for(var f=0;f<d;++f){var c=r[f];v.Color.pack(c.color,i,o),o+=v.Color.packedLength,i[o++]=c.offset,i[o++]=c.count;var u=c.batchIds,h=u.length;i[o++]=h;for(var l=0;l<h;++l)i[o++]=u[l]}return i}var E=32767,N=new r.Cartesian3,T=new r.Cartesian3,k=new r.Cartesian3,B=new r.Cartesian3,L=new r.Cartesian3,O=new n.Cartographic,U=new s.Rectangle;function P(a,t){var i;w(a.packedBuffer);var o=m.indexBytesPerElement;i=2===o?new Uint16Array(a.indices):new Uint32Array(a.indices);var s,d,f,h=new Uint16Array(a.positions),l=new Uint32Array(a.counts),g=new Uint32Array(a.indexCounts),p=new Uint32Array(a.batchIds),x=new Uint32Array(a.batchTableColors),P=new Array(l.length),S=C,F=y,R=I,D=m.min,M=m.max,_=a.minimumHeights,G=a.maximumHeights;e.defined(_)&&e.defined(G)&&(_=new Float32Array(_),G=new Float32Array(G));var Y=h.length/2,V=h.subarray(0,Y),H=h.subarray(Y,2*Y);c.AttributeCompression.zigZagDeltaDecode(V,H);var W=new Float64Array(3*Y);for(s=0;s<Y;++s){var z=V[s],Z=H[s],j=r.CesiumMath.lerp(R.west,R.east,z/E),q=r.CesiumMath.lerp(R.south,R.north,Z/E),J=n.Cartographic.fromRadians(j,q,0,O),K=F.cartographicToCartesian(J,N);r.Cartesian3.pack(K,W,3*s)}var Q=l.length,X=new Array(Q),$=new Array(Q),ee=0,ae=0;for(s=0;s<Q;++s)X[s]=ee,$[s]=ae,ee+=l[s],ae+=g[s];var re,ne=new Float32Array(3*Y*2),te=new Uint16Array(2*Y),ie=new Uint32Array($.length),oe=new Uint32Array(g.length),se=[],de={};for(s=0;s<Q;++s)f=x[s],e.defined(de[f])?(de[f].positionLength+=l[s],de[f].indexLength+=g[s],de[f].batchIds.push(s)):de[f]={positionLength:l[s],indexLength:g[s],offset:0,indexOffset:0,batchIds:[s]};var fe=0,ce=0;for(f in de)if(de.hasOwnProperty(f)){re=de[f],re.offset=fe,re.indexOffset=ce;var ue=2*re.positionLength,he=2*re.indexLength+6*re.positionLength;fe+=ue,ce+=he,re.indexLength=he}var le=[];for(f in de)de.hasOwnProperty(f)&&(re=de[f],le.push({color:v.Color.fromRgba(parseInt(f)),offset:re.indexOffset,count:re.indexLength,batchIds:re.batchIds}));for(s=0;s<Q;++s){f=x[s],re=de[f];var ge=re.offset,pe=3*ge,be=ge,ve=X[s],Ce=l[s],ye=p[s],Ie=D,me=M;e.defined(_)&&e.defined(G)&&(Ie=_[s],me=G[s]);var we=Number.POSITIVE_INFINITY,xe=Number.NEGATIVE_INFINITY,Ae=Number.POSITIVE_INFINITY,Ee=Number.NEGATIVE_INFINITY;for(d=0;d<Ce;++d){var Ne=r.Cartesian3.unpack(W,3*ve+3*d,N);F.scaleToGeodeticSurface(Ne,Ne);var Te=F.cartesianToCartographic(Ne,O),ke=Te.latitude,Be=Te.longitude;we=Math.min(ke,we),xe=Math.max(ke,xe),Ae=Math.min(Be,Ae),Ee=Math.max(Be,Ee);var Le=F.geodeticSurfaceNormal(Ne,T),Oe=r.Cartesian3.multiplyByScalar(Le,Ie,k),Ue=r.Cartesian3.add(Ne,Oe,B);Oe=r.Cartesian3.multiplyByScalar(Le,me,Oe);var Pe=r.Cartesian3.add(Ne,Oe,L);r.Cartesian3.subtract(Pe,S,Pe),r.Cartesian3.subtract(Ue,S,Ue),r.Cartesian3.pack(Pe,ne,pe),r.Cartesian3.pack(Ue,ne,pe+3),te[be]=ye,te[be+1]=ye,pe+=6,be+=2}R=U,R.west=Ae,R.east=Ee,R.south=we,R.north=xe,P[s]=b.OrientedBoundingBox.fromRectangle(R,D,M,F);var Se=re.indexOffset,Fe=$[s],Re=g[s];for(ie[s]=Se,d=0;d<Re;d+=3){var De=i[Fe+d]-ve,Me=i[Fe+d+1]-ve,_e=i[Fe+d+2]-ve;se[Se++]=2*De+ge,se[Se++]=2*Me+ge,se[Se++]=2*_e+ge,se[Se++]=2*_e+1+ge,se[Se++]=2*Me+1+ge,se[Se++]=2*De+1+ge}for(d=0;d<Ce;++d){var Ge=d,Ye=(d+1)%Ce;se[Se++]=2*Ge+1+ge,se[Se++]=2*Ye+ge,se[Se++]=2*Ge+ge,se[Se++]=2*Ge+1+ge,se[Se++]=2*Ye+1+ge,se[Se++]=2*Ye+ge}re.offset+=2*Ce,re.indexOffset=Se,oe[s]=Se-ie[s]}se=u.IndexDatatype.createTypedArray(ne.length/3,se);for(var Ve=le.length,He=0;He<Ve;++He){for(var We=le[He].batchIds,ze=0,Ze=We.length,je=0;je<Ze;++je)ze+=oe[We[je]];le[He].count=ze}var qe=2===se.BYTES_PER_ELEMENT?u.IndexDatatype.UNSIGNED_SHORT:u.IndexDatatype.UNSIGNED_INT,Je=A(qe,P,le);return t.push(ne.buffer,se.buffer,ie.buffer,oe.buffer,te.buffer,Je.buffer),{positions:ne.buffer,indices:se.buffer,indexOffsets:ie.buffer,indexCounts:oe.buffer,batchIds:te.buffer,packedBuffer:Je.buffer}}var S=g(P);return S}));