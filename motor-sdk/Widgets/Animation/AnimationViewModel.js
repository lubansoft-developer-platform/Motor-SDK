import binarySearch from"../../Core/binarySearch.js";import ClockRange from"../../Core/ClockRange.js";import ClockStep from"../../Core/ClockStep.js";import defined from"../../Core/defined.js";import DeveloperError from"../../Core/DeveloperError.js";import JulianDate from"../../Core/JulianDate.js";import knockout from"../../ThirdParty/knockout.js";import sprintf from"../../ThirdParty/sprintf.js";import createCommand from"../createCommand.js";import ToggleButtonViewModel from"../ToggleButtonViewModel.js";var monthNames=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],realtimeShuttleRingAngle=15,maxShuttleRingAngle=105;function numberComparator(e,t){return e-t}function getTypicalMultiplierIndex(e,t){var i=binarySearch(t,e,numberComparator);return i<0?~i:i}function angleToMultiplier(e,t){if(Math.abs(e)<=realtimeShuttleRingAngle)return e/realtimeShuttleRingAngle;var i,o,n=realtimeShuttleRingAngle,r=maxShuttleRingAngle,l=0;return e>0?(i=Math.log(t[t.length-1]),o=(i-l)/(r-n),Math.exp(l+o*(e-n))):(i=Math.log(-t[0]),o=(i-l)/(r-n),-Math.exp(l+o*(Math.abs(e)-n)))}function multiplierToAngle(e,t,i){if(i.clockStep===ClockStep.SYSTEM_CLOCK)return realtimeShuttleRingAngle;if(Math.abs(e)<=1)return e*realtimeShuttleRingAngle;var o=t[t.length-1];e>o?e=o:e<-o&&(e=-o);var n,r,l=realtimeShuttleRingAngle,a=maxShuttleRingAngle,u=0;return e>0?(n=Math.log(o),r=(n-u)/(a-l),(Math.log(e)-u)/r+l):(n=Math.log(-t[0]),r=(n-u)/(a-l),-((Math.log(Math.abs(e))-u)/r+l))}function AnimationViewModel(e){if(!defined(e))throw new DeveloperError("clockViewModel is required.");var t=this;this._clockViewModel=e,this._allShuttleRingTicks=[],this._dateFormatter=AnimationViewModel.defaultDateFormatter,this._timeFormatter=AnimationViewModel.defaultTimeFormatter,this.shuttleRingDragging=!1,this.snapToTicks=!1,knockout.track(this,["_allShuttleRingTicks","_dateFormatter","_timeFormatter","shuttleRingDragging","snapToTicks"]),this._sortedFilteredPositiveTicks=[],this.setShuttleRingTicks(AnimationViewModel.defaultTicks),this.timeLabel=void 0,knockout.defineProperty(this,"timeLabel",(function(){return t._timeFormatter(t._clockViewModel.currentTime,t)})),this.dateLabel=void 0,knockout.defineProperty(this,"dateLabel",(function(){return t._dateFormatter(t._clockViewModel.currentTime,t)})),this.multiplierLabel=void 0,knockout.defineProperty(this,"multiplierLabel",(function(){var e=t._clockViewModel;if(e.clockStep===ClockStep.SYSTEM_CLOCK)return"Today";var i=e.multiplier;return i%1===0?i.toFixed(0)+"x":i.toFixed(3).replace(/0{0,3}$/,"")+"x"})),this.shuttleRingAngle=void 0,knockout.defineProperty(this,"shuttleRingAngle",{get:function(){return multiplierToAngle(e.multiplier,t._allShuttleRingTicks,e)},set:function(e){e=Math.max(Math.min(e,maxShuttleRingAngle),-maxShuttleRingAngle);var i=t._allShuttleRingTicks,o=t._clockViewModel;if(o.clockStep=ClockStep.SYSTEM_CLOCK_MULTIPLIER,Math.abs(e)!==maxShuttleRingAngle){var n=angleToMultiplier(e,i);if(t.snapToTicks)n=i[getTypicalMultiplierIndex(n,i)];else if(0!==n){var r=Math.abs(n);if(r>100){var l=r.toFixed(0).length-2,a=Math.pow(10,l);n=Math.round(n/a)*a|0}else r>realtimeShuttleRingAngle?n=Math.round(n):r>1?n=+n.toFixed(1):r>0&&(n=+n.toFixed(2))}o.multiplier=n}else o.multiplier=e>0?i[i.length-1]:i[0]}}),this._canAnimate=void 0,knockout.defineProperty(this,"_canAnimate",(function(){var e=t._clockViewModel,i=e.clockRange;if(t.shuttleRingDragging||i===ClockRange.UNBOUNDED)return!0;var o=e.multiplier,n=e.currentTime,r=e.startTime,l=!1;if(i===ClockRange.LOOP_STOP)l=JulianDate.greaterThan(n,r)||n.equals(r)&&o>0;else{var a=e.stopTime;l=JulianDate.greaterThan(n,r)&&JulianDate.lessThan(n,a)||n.equals(r)&&o>0||n.equals(a)&&o<0}return l||(e.shouldAnimate=!1),l})),this._isSystemTimeAvailable=void 0,knockout.defineProperty(this,"_isSystemTimeAvailable",(function(){var e=t._clockViewModel,i=e.clockRange;if(i===ClockRange.UNBOUNDED)return!0;var o=e.systemTime;return JulianDate.greaterThanOrEquals(o,e.startTime)&&JulianDate.lessThanOrEquals(o,e.stopTime)})),this._isAnimating=void 0,knockout.defineProperty(this,"_isAnimating",(function(){return t._clockViewModel.shouldAnimate&&(t._canAnimate||t.shuttleRingDragging)}));var i=createCommand((function(){var e=t._clockViewModel;e.shouldAnimate?e.shouldAnimate=!1:t._canAnimate&&(e.shouldAnimate=!0)}));this._pauseViewModel=new ToggleButtonViewModel(i,{toggled:knockout.computed((function(){return!t._isAnimating})),tooltip:"Pause"});var o=createCommand((function(){var e=t._clockViewModel,i=e.multiplier;i>0&&(e.multiplier=-i),e.shouldAnimate=!0}));this._playReverseViewModel=new ToggleButtonViewModel(o,{toggled:knockout.computed((function(){return t._isAnimating&&e.multiplier<0})),tooltip:"Play Reverse"});var n=createCommand((function(){var e=t._clockViewModel,i=e.multiplier;i<0&&(e.multiplier=-i),e.shouldAnimate=!0}));this._playForwardViewModel=new ToggleButtonViewModel(n,{toggled:knockout.computed((function(){return t._isAnimating&&e.multiplier>0&&e.clockStep!==ClockStep.SYSTEM_CLOCK})),tooltip:"Play Forward"});var r=createCommand((function(){t._clockViewModel.clockStep=ClockStep.SYSTEM_CLOCK}),knockout.getObservable(this,"_isSystemTimeAvailable"));this._playRealtimeViewModel=new ToggleButtonViewModel(r,{toggled:knockout.computed((function(){return e.clockStep===ClockStep.SYSTEM_CLOCK})),tooltip:knockout.computed((function(){return t._isSystemTimeAvailable?"Today (real-time)":"Current time not in range"}))}),this._slower=createCommand((function(){var e=t._clockViewModel,i=t._allShuttleRingTicks,o=e.multiplier,n=getTypicalMultiplierIndex(o,i)-1;n>=0&&(e.multiplier=i[n])})),this._faster=createCommand((function(){var e=t._clockViewModel,i=t._allShuttleRingTicks,o=e.multiplier,n=getTypicalMultiplierIndex(o,i)+1;n<i.length&&(e.multiplier=i[n])}))}AnimationViewModel.defaultDateFormatter=function(e,t){var i=JulianDate.toGregorianDate(e);return monthNames[i.month-1]+" "+i.day+" "+i.year},AnimationViewModel.defaultTicks=[.001,.002,.005,.01,.02,.05,.1,.25,.5,1,2,5,10,15,30,60,120,300,600,900,1800,3600,7200,14400,21600,43200,86400,172800,345600,604800],AnimationViewModel.defaultTimeFormatter=function(e,t){var i=JulianDate.toGregorianDate(e),o=Math.round(i.millisecond);return Math.abs(t._clockViewModel.multiplier)<1?sprintf("%02d:%02d:%02d.%03d",i.hour,i.minute,i.second,o):sprintf("%02d:%02d:%02d UTC",i.hour,i.minute,i.second)},AnimationViewModel.prototype.getShuttleRingTicks=function(){return this._sortedFilteredPositiveTicks.slice(0)},AnimationViewModel.prototype.setShuttleRingTicks=function(e){if(!defined(e))throw new DeveloperError("positiveTicks is required.");var t,i,o,n={},r=this._sortedFilteredPositiveTicks;for(r.length=0,t=0,i=e.length;t<i;++t)o=e[t],n.hasOwnProperty(o)||(n[o]=!0,r.push(o));r.sort(numberComparator);var l=[];for(i=r.length,t=i-1;t>=0;--t)o=r[t],0!==o&&l.push(-o);Array.prototype.push.apply(l,r),this._allShuttleRingTicks=l},Object.defineProperties(AnimationViewModel.prototype,{slower:{get:function(){return this._slower}},faster:{get:function(){return this._faster}},clockViewModel:{get:function(){return this._clockViewModel}},pauseViewModel:{get:function(){return this._pauseViewModel}},playReverseViewModel:{get:function(){return this._playReverseViewModel}},playForwardViewModel:{get:function(){return this._playForwardViewModel}},playRealtimeViewModel:{get:function(){return this._playRealtimeViewModel}},dateFormatter:{get:function(){return this._dateFormatter},set:function(e){if("function"!==typeof e)throw new DeveloperError("dateFormatter must be a function");this._dateFormatter=e}},timeFormatter:{get:function(){return this._timeFormatter},set:function(e){if("function"!==typeof e)throw new DeveloperError("timeFormatter must be a function");this._timeFormatter=e}}}),AnimationViewModel._maxShuttleRingAngle=maxShuttleRingAngle,AnimationViewModel._realtimeShuttleRingAngle=realtimeShuttleRingAngle;export default AnimationViewModel;