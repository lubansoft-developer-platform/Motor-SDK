import buildModuleUrl from"../../Core/buildModuleUrl.js";import Cartesian3 from"../../Core/Cartesian3.js";import Clock from"../../Core/Clock.js";import defaultValue from"../../Core/defaultValue.js";import defined from"../../Core/defined.js";import destroyObject from"../../Core/destroyObject.js";import DeveloperError from"../../Core/DeveloperError.js";import Ellipsoid from"../../Core/Ellipsoid.js";import FeatureDetection from"../../Core/FeatureDetection.js";import formatError from"../../Core/formatError.js";import requestAnimationFrame from"../../Core/requestAnimationFrame.js";import ScreenSpaceEventHandler from"../../Core/ScreenSpaceEventHandler.js";import createWorldImagery from"../../Scene/createWorldImagery.js";import Globe from"../../Scene/Globe.js";import Moon from"../../Scene/Moon.js";import Scene from"../../Scene/Scene.js";import SceneMode from"../../Scene/SceneMode.js";import ShadowMode from"../../Scene/ShadowMode.js";import SkyAtmosphere from"../../Scene/SkyAtmosphere.js";import SkyBox from"../../Scene/SkyBox.js";import Sun from"../../Scene/Sun.js";import getElement from"../getElement.js";function getDefaultSkyBoxUrl(e){return buildModuleUrl("Assets/Textures/SkyBox/tycho2t3_80_"+e+".jpg")}function FpsCtrl(e,t){var r,n=1e3/e,i=null,o=-1;function s(e){null===i&&(i=e);var a=Math.floor((e-i)/n);a>o&&(o=a,t()),r=requestAnimationFrame(s)}this.isPlaying=!1,this.frameRate=function(t){if(!arguments.length)return e;e=t,n=1e3/e,o=-1,i=null},this.start=function(){this.isPlaying||(this.isPlaying=!0,r=requestAnimationFrame(s))},this.pause=function(){this.isPlaying&&(cancelAnimationFrame(r),this.isPlaying=!1,i=null,o=-1)},this.destroy=function(){cancelAnimationFrame(r)}}function startRenderLoop(e){function t(t){if(!e.isDestroyed())if(e._useDefaultRenderLoop){var r=60;defined(e._targetFrameRate)&&(r=e._targetFrameRate);var n=new FpsCtrl(r,(()=>{try{e.resize(),e.render()}catch(r){if(e._useDefaultRenderLoop=!1,e._renderLoopRunning=!1,e._showRenderLoopErrors){var t="An error occurred while rendering.  Rendering has stopped.";e.showErrorPanel(t,void 0,r)}}}));e.destroyObj.fpsAnimate=n,n.start()}else e._renderLoopRunning=!1}e._renderLoopRunning=!0,e.destroyObj.wigetRenderAnimate=requestAnimationFrame(t)}function configurePixelRatio(e){var t=e._useBrowserRecommendedResolution?1:window.devicePixelRatio;return t*=e._resolutionScale,defined(e._scene)&&(e._scene.pixelRatio=t),t}function configureCanvasSize(e){var t=e._canvas,r=t.clientWidth,n=t.clientHeight,i=configurePixelRatio(e);e._canvasClientWidth=r,e._canvasClientHeight=n,r*=i,n*=i,t.width=r,t.height=n,e._canRender=0!==r&&0!==n,e._lastDevicePixelRatio=window.devicePixelRatio}function configureCameraFrustum(e){var t=e._canvas,r=t.width,n=t.height;if(0!==r&&0!==n){var i=e._scene.camera.frustum;defined(i.aspectRatio)?i.aspectRatio=r/n:(i.top=i.right*(n/r),i.bottom=-i.top)}}function CesiumWidget(e,t){if(!defined(e))throw new DeveloperError("container is required.");e=getElement(e),t=defaultValue(t,defaultValue.EMPTY_OBJECT);var r=document.createElement("div");r.className="cesium-widget",e.appendChild(r);var n=document.createElement("canvas"),i=FeatureDetection.supportsImageRenderingPixelated();function o(){n!==n.ownerDocument.activeElement&&n.ownerDocument.activeElement.blur()}this._supportsImageRenderingPixelated=i,i&&(n.style.imageRendering=FeatureDetection.imageRenderingValue()),n.oncontextmenu=function(){return!1},n.onselectstart=function(){return!1},n.addEventListener("mousedown",o),n.addEventListener("pointerdown",o);const s=[];s.push((()=>{n.removeEventListener("pointerdown",o)})),s.push((()=>{n.removeEventListener("mousedown",o)})),r.appendChild(n);var a=document.createElement("div");a.className="cesium-widget-credits";var d=defined(t.creditContainer)?getElement(t.creditContainer):r;d.appendChild(a);var c=defined(t.creditViewport)?getElement(t.creditViewport):r,l=defaultValue(t.showRenderLoopErrors,!0),u=defaultValue(t.useBrowserRecommendedResolution,!0);this._element=r,this._removeListenerAry=s,this._container=e,this._canvas=n,this._canvasClientWidth=0,this._canvasClientHeight=0,this._lastDevicePixelRatio=0,this._creditViewport=c,this._creditContainer=d,this._innerCreditContainer=a,this._canRender=!1,this._renderLoopRunning=!1,this._showRenderLoopErrors=l,this._resolutionScale=1,this._useBrowserRecommendedResolution=u,this._forceResize=!1,this._clock=defined(t.clock)?t.clock:new Clock,this.destroyObj={wigetRenderAnimate:0,fpsAnimate:void 0},configureCanvasSize(this);try{var m=new Scene({canvas:n,contextOptions:t.contextOptions,creditContainer:a,creditViewport:c,mapProjection:t.mapProjection,orderIndependentTranslucency:t.orderIndependentTranslucency,scene3DOnly:defaultValue(t.scene3DOnly,!1),terrainExaggeration:t.terrainExaggeration,shadows:t.shadows,mapMode2D:t.mapMode2D,requestRenderMode:t.requestRenderMode,maximumRenderTimeChange:t.maximumRenderTimeChange,isPlaneMode:t.isPlaneMode});this._scene=m,m.camera.constrainedAxis=Cartesian3.UNIT_Z,configurePixelRatio(this),configureCameraFrustum(this);var h=defaultValue(m.mapProjection.ellipsoid,Ellipsoid.WGS84),p=t.globe;defined(p)||(p=new Globe(h)),!1!==p&&(m.globe=p,m.globe.shadows=defaultValue(t.terrainShadows,ShadowMode.RECEIVE_ONLY));var f=t.skyBox;defined(f)||(f=new SkyBox({sources:{positiveX:getDefaultSkyBoxUrl("px"),negativeX:getDefaultSkyBoxUrl("mx"),positiveY:getDefaultSkyBoxUrl("py"),negativeY:getDefaultSkyBoxUrl("my"),positiveZ:getDefaultSkyBoxUrl("pz"),negativeZ:getDefaultSkyBoxUrl("mz")}})),!1!==f&&(m.skyBox=f,m.sun=new Sun,m.moon=new Moon);var g=t.skyAtmosphere;defined(g)||(g=new SkyAtmosphere(h)),!1!==g&&(m.skyAtmosphere=g);var v=!1!==t.globe&&t.imageryProvider;defined(v)||(v=createWorldImagery()),!1!==v&&m.imageryLayers.addImageryProvider(v),defined(t.terrainProvider)&&!1!==t.globe&&(m.terrainProvider=t.terrainProvider),this._screenSpaceEventHandler=new ScreenSpaceEventHandler(n),defined(t.sceneMode)&&(t.sceneMode===SceneMode.SCENE2D&&this._scene.morphTo2D(0),t.sceneMode===SceneMode.COLUMBUS_VIEW&&this._scene.morphToColumbusView(0)),this._useDefaultRenderLoop=void 0,this.useDefaultRenderLoop=defaultValue(t.useDefaultRenderLoop,!0),this._targetFrameRate=void 0,this.targetFrameRate=t.targetFrameRate;var _=this;m.renderError.addEventListener((function(e,t){if(_._useDefaultRenderLoop=!1,_._renderLoopRunning=!1,_._showRenderLoopErrors){var r="An error occurred while rendering.  Rendering has stopped.";_.showErrorPanel(r,void 0,t)}}))}catch(C){if(l){var w="Error constructing CesiumWidget.",R='Visit <a href="http://get.webgl.org">http://get.webgl.org</a> to verify that your web browser and hardware support WebGL.  Consider trying a different web browser or updating your video drivers.  Detailed error information is below:';this.showErrorPanel(w,R,C)}throw C}}Object.defineProperties(CesiumWidget.prototype,{container:{get:function(){return this._container}},canvas:{get:function(){return this._canvas}},creditContainer:{get:function(){return this._creditContainer}},creditViewport:{get:function(){return this._creditViewport}},scene:{get:function(){return this._scene}},imageryLayers:{get:function(){return this._scene.imageryLayers}},terrainProvider:{get:function(){return this._scene.terrainProvider},set:function(e){this._scene.terrainProvider=e}},camera:{get:function(){return this._scene.camera}},clock:{get:function(){return this._clock}},screenSpaceEventHandler:{get:function(){return this._screenSpaceEventHandler}},targetFrameRate:{get:function(){return this._targetFrameRate},set:function(e){if(e<=0)throw new DeveloperError("targetFrameRate must be greater than 0, or undefined.");this._targetFrameRate=e}},useDefaultRenderLoop:{get:function(){return this._useDefaultRenderLoop},set:function(e){this._useDefaultRenderLoop!==e&&(this._useDefaultRenderLoop=e,e&&!this._renderLoopRunning&&startRenderLoop(this))}},resolutionScale:{get:function(){return this._resolutionScale},set:function(e){if(e<=0)throw new DeveloperError("resolutionScale must be greater than 0.");this._resolutionScale!==e&&(this._resolutionScale=e,this._forceResize=!0)}},useBrowserRecommendedResolution:{get:function(){return this._useBrowserRecommendedResolution},set:function(e){this._useBrowserRecommendedResolution!==e&&(this._useBrowserRecommendedResolution=e,this._forceResize=!0)}}}),CesiumWidget.prototype.showErrorPanel=function(e,t,r){var n=this._element,i=document.createElement("div");i.className="cesium-widget-errorPanel";var o=document.createElement("div");o.className="cesium-widget-errorPanel-content",i.appendChild(o);var s=document.createElement("div");s.className="cesium-widget-errorPanel-header",s.appendChild(document.createTextNode(e)),o.appendChild(s);var a=document.createElement("div");function d(){a.style.maxHeight=Math.max(Math.round(.9*n.clientHeight-100),30)+"px"}if(a.className="cesium-widget-errorPanel-scroll",o.appendChild(a),d(),defined(window.addEventListener)&&window.addEventListener("resize",d,!1),defined(t)){var c=document.createElement("div");c.className="cesium-widget-errorPanel-message",c.innerHTML="<p>"+t+"</p>",a.appendChild(c)}var l="(no error details available)";defined(r)&&(l=formatError(r));var u=document.createElement("div");u.className="cesium-widget-errorPanel-message",u.appendChild(document.createTextNode(l)),a.appendChild(u);var m=document.createElement("div");m.className="cesium-widget-errorPanel-buttonPanel",o.appendChild(m);var h=document.createElement("button");h.setAttribute("type","button"),h.className="cesium-button",h.appendChild(document.createTextNode("OK")),h.onclick=function(){defined(d)&&defined(window.removeEventListener)&&window.removeEventListener("resize",d,!1),n.removeChild(i)},m.appendChild(h),n.appendChild(i),"undefined"!==typeof console&&console.error(e+"\n"+t+"\n"+l)},CesiumWidget.prototype.isDestroyed=function(){return!1},CesiumWidget.prototype.destroy=function(){this._scene=this._scene&&this._scene.destroy(),this._removeListenerAry.map((e=>{e()})),this._container.removeChild(this._element),this._creditContainer.removeChild(this._innerCreditContainer),this.destroyObj.fpsAnimate&&this.destroyObj.fpsAnimate.destroy(),0!==this.destroyObj.wigetRenderAnimate&&cancelAnimationFrame(this.destroyObj.wigetRenderAnimate),this._screenSpaceEventHandler=void 0,this._creditContainer=void 0,this._creditViewport=void 0,this._container=void 0,this._innerCreditContainer=void 0,this._canvas=void 0,this._element=void 0,destroyObject(this)},CesiumWidget.prototype.resize=function(){var e=this._canvas;(this._forceResize||this._canvasClientWidth!==e.clientWidth||this._canvasClientHeight!==e.clientHeight||this._lastDevicePixelRatio!==window.devicePixelRatio)&&(this._forceResize=!1,configureCanvasSize(this),configureCameraFrustum(this),this._scene.requestRender())},CesiumWidget.prototype.render=function(){if(this._canRender){this._scene.initializeFrame();var e=this._clock.tick();this._scene.render(e)}else this._clock.tick()};export default CesiumWidget;