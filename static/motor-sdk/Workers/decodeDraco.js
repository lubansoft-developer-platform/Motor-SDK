define(["./when-52cea266","./Check-abb9b75f","./Cartesian2-7312ebeb","./Rectangle-9e59d921","./Transforms-f87238cb","./Matrix4-f7d115f5","./RuntimeError-02840484","./WebGLConstants-52779751","./ComponentDatatype-0d64f16b","./GeometryAttribute-55231797","./PrimitiveType-875d1f73","./IndexDatatype-d59649f4","./createTaskProcessorWorker","./AxisAlignedBoundingBox-dabc1f48","./EllipsoidRhumbLine-bfe2f143","./PolygonPipeline-c4c3c8f5","./CreatePhysicalArray-8ebb8367","./materem-62ee4902","./EmWrapperManager-0f203c26","./EmLBDeal-e7aeb335"],(function(e,r,t,a,n,o,i,d,y,I,s,f,u,c,A,m,l,b,p,T){"use strict";var N,v,w,P={DRACO_COMPRESSION:0,MATER_COMPRESSION:1,PROJECTIVE_TRANSFORM:2,POINT_CLOUD:3},O=Object.freeze(P);function C(e,r){for(var t=e.num_points(),a=e.num_faces(),n=new N.DracoInt32Array,o=3*a,i=f.IndexDatatype.createTypedArray(t,o),d=0,y=0;y<a;++y)r.GetFaceFromMesh(e,y,n),i[d+0]=n.GetValue(0),i[d+1]=n.GetValue(1),i[d+2]=n.GetValue(2),d+=3;return N.destroy(n),{typedArray:i,numberOfIndices:o}}function E(e,r,t,a,n){var o,i;a.quantizationBits<=8?(i=new N.DracoUInt8Array,o=new Uint8Array(n),r.GetAttributeUInt8ForAllPoints(e,t,i)):(i=new N.DracoUInt16Array,o=new Uint16Array(n),r.GetAttributeUInt16ForAllPoints(e,t,i));for(var d=0;d<n;++d)o[d]=i.GetValue(d);return N.destroy(i),o}function D(e,r,t,a){var n,o;switch(t.data_type()){case 1:case 11:o=new N.DracoInt8Array,n=new Int8Array(a),r.GetAttributeInt8ForAllPoints(e,t,o);break;case 2:o=new N.DracoUInt8Array,n=new Uint8Array(a),r.GetAttributeUInt8ForAllPoints(e,t,o);break;case 3:o=new N.DracoInt16Array,n=new Int16Array(a),r.GetAttributeInt16ForAllPoints(e,t,o);break;case 4:o=new N.DracoUInt16Array,n=new Uint16Array(a),r.GetAttributeUInt16ForAllPoints(e,t,o);break;case 5:case 7:o=new N.DracoInt32Array,n=new Int32Array(a),r.GetAttributeInt32ForAllPoints(e,t,o);break;case 6:case 8:o=new N.DracoUInt32Array,n=new Uint32Array(a),r.GetAttributeUInt32ForAllPoints(e,t,o);break;case 9:case 10:o=new N.DracoFloat32Array,n=new Float32Array(a),r.GetAttributeFloatForAllPoints(e,t,o);break}for(var i=0;i<a;++i)n[i]=o.GetValue(i);return N.destroy(o),n}function h(r,t,a){var n,o=r.num_points(),i=a.num_components(),d=new N.AttributeQuantizationTransform;if(d.InitFromAttribute(a)){for(var I=new Array(i),s=0;s<i;++s)I[s]=d.min_value(s);n={quantizationBits:d.quantization_bits(),minValues:I,range:d.range(),octEncoded:!1}}N.destroy(d),d=new N.AttributeOctahedronTransform,d.InitFromAttribute(a)&&(n={quantizationBits:d.quantization_bits(),octEncoded:!0}),N.destroy(d);var f,u=o*i;f=e.defined(n)?E(r,t,a,n,u):D(r,t,a,u);var c=y.ComponentDatatype.fromTypedArray(f);return{array:f,data:{componentsPerAttribute:i,componentDatatype:c,byteOffset:a.byte_offset(),byteStride:y.ComponentDatatype.getSizeInBytes(c)*i,normalized:a.normalized(),quantization:n}}}function G(e){var r=new N.Decoder;e.dequantizeInShader&&(r.SkipAttributeTransform(N.POSITION),r.SkipAttributeTransform(N.NORMAL));var t=new N.DecoderBuffer;t.Init(e.buffer,e.buffer.length);var a=r.GetEncodedGeometryType(t);if(a!==N.POINT_CLOUD)throw new i.RuntimeError("Draco geometry type must be POINT_CLOUD.");var n=new N.PointCloud,o=r.DecodeBufferToPointCloud(t,n);if(!o.ok()||0===n.ptr)throw new i.RuntimeError("Error decoding draco point cloud: "+o.error_msg());N.destroy(t);var d={},y=e.properties;for(var I in y)if(y.hasOwnProperty(I)){var s=y[I],f=r.GetAttributeByUniqueId(n,s);d[I]=h(n,r,f)}return N.destroy(n),N.destroy(r),d}function F(r){var a=new N.Decoder,n=["POSITION","NORMAL","COLOR","TEX_COORD"];if(r.dequantizeInShader)for(var d=0;d<n.length;++d)a.SkipAttributeTransform(N[n[d]]);var y=r.bufferView,I=new N.DecoderBuffer;I.Init(r.array,y.byteLength);var s=a.GetEncodedGeometryType(I);if(s!==N.TRIANGULAR_MESH)throw new i.RuntimeError("Unsupported draco mesh geometry type.");var f=new N.Mesh,u=a.DecodeBufferToMesh(I,f);if(!u.ok()||0===f.ptr)throw new i.RuntimeError("Error decoding draco mesh geometry: "+u.error_msg());N.destroy(I);var c={},A=[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY],m=[Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY],b=r.compressedAttributes;for(var p in b)if(b.hasOwnProperty(p)){var P=b[p],O=a.GetAttributeByUniqueId(f,P);if(c[p]=h(f,a,O),"POSITION"===p&&(r.projected||r.absPlaned)&&!r.isInstance){var E=r.isYUp,D=r.projectionString,G=r.dCenX,F=r.dCenY,_=r.dCenZ,S=new T.EmLBDeal,g=S.init(D,new t.Cartesian3(G,F,_));if(g){e.defined(r.planishBorderInfoAry)&&S.setPlanishBorderInfoAry(r.planishBorderInfoAry);var M=c[p].array,V=r.matrix;r.projected?S.computeProjToCartesianAry(M,E,o.Matrix4.fromArray(V)):S.computeCartesianToProjAry(M,E,o.Matrix4.fromArray(V));for(var B=new Float32Array(M.length),R=0;R<M.length;++R)B[R]=M[R],A[R%3]>B[R]&&(A[R%3]=B[R]),m[R%3]<B[R]&&(m[R%3]=B[R]);c[p].array=B}S.destroy()}}var U=C(f,a);if(r.isNeedPhy){var L,x=e.defined(c["POSITION"])?c["POSITION"].array:void 0,Y=e.defined(c["_BATCHID"])?c["_BATCHID"].array:void 0,k=U.typedArray,z=l.CreatePhysicalArray.createPhysicalArrayFromModel(v,w,r.primitiveMode,x,Y,k,L);c["_PHYSICAL"]={array:z}}var j={indexArray:U,attributeData:c,min:A,max:m};return N.destroy(f),N.destroy(a),j}function _(e,r){var a={};if(e.projected){var n=e.isYUp,i=e.projectionString,d=e.dCenX,y=e.dCenY,I=e.dCenZ,s=new T.EmLBDeal,f=s.init(i,new t.Cartesian3(d,y,I));if(f){var u=new Float32Array(e.array.buffer,0),c=e.matrix;s.computeProjToCartesianAry(u,n,o.Matrix4.fromArray(c));for(var A=new Float32Array(u.length),m=0;m<u.length;++m)A[m]=u[m];a={attributeData:A},r.push(A.buffer)}s.destroy()}return a}function S(e,r,t){var a=y.ComponentDatatype.fromTypedArray(e);return{array:e,data:{componentsPerAttribute:r,componentDatatype:a,byteOffset:0,byteStride:y.ComponentDatatype.getSizeInBytes(a)*r,normalized:t,quantization:void 0}}}function g(r){var a=r.bufferView,n=new v.MaterPrimitiveDecoder;if(!n.Decode(r.array,a.byteLength))throw v.destroy(n),new i.RuntimeError("error mater compress.");for(var d,y=n.GetPtNum(),I=n.GetIndexNum(),s=f.IndexDatatype.createTypedArray(y,I),u=0;u<I;++u)s[u]=n.GetIndex(u);if(n.IsHaveEdgeCheck())for(d=new Int8Array(I),u=0;u<I;++u)d[u]=n.GetEdgeCheck(u);var c={},A=[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY],m=[Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY],b=new Float32Array(3*y);for(u=0;u<y;++u)b[3*u]=n.GetPtVal(u,0),b[3*u+1]=n.GetPtVal(u,1),b[3*u+2]=n.GetPtVal(u,2);if(c["POSITION"]=S(b,3,!1),(r.projected||r.absPlaned)&&!r.isInstance){var p=r.isYUp,N=r.projectionString,P=r.dCenX,O=r.dCenY,C=r.dCenZ,E=new T.EmLBDeal,D=E.init(N,new t.Cartesian3(P,O,C));if(D){var h=c["POSITION"].array,G=r.matrix;r.projected?E.computeProjToCartesianAry(h,p,o.Matrix4.fromArray(G)):E.computeCartesianToProjAry(h,p,o.Matrix4.fromArray(G));for(var F=new Float32Array(h.length),_=0;_<h.length;++_)F[_]=h[_],A[_%3]>F[_]&&(A[_%3]=F[_]),m[_%3]<F[_]&&(m[_%3]=F[_]);c["POSITION"].array=F}E.destroy()}if(n.IsHaveUV()){var g=new Float32Array(2*y);for(u=0;u<y;++u)g[2*u]=n.GetUVVal(u,0),g[2*u+1]=n.GetUVVal(u,1);c["TEXCOORD_0"]=S(g,2,!1)}if(n.IsHaveNormal()){var M=new Float32Array(3*y);for(u=0;u<y;++u)M[3*u]=n.GetNormalVal(u,0),M[3*u+1]=n.GetNormalVal(u,1),M[3*u+2]=n.GetNormalVal(u,2);c["NORMAL"]=S(M,3,!0)}if(n.IsHaveBatchId()){var V=new Float32Array(y);for(u=0;u<y;++u)V[u]=n.GetBatchId(u);c["_BATCHID"]=S(V,1,!1)}if(n.IsHaveMaterialId()){var B=new Float32Array(y);for(u=0;u<y;++u)B[u]=n.GetMaterialId(u);c["_MATERIALID"]=S(B,1,!1)}if(n.IsHaveOutlineCoord()){var R=new Int8Array(y);for(u=0;u<y;++u)R[u]=n.GetOutlineCoord(u);c["_OUTLINECOORD"]=S(R,1,!1)}if(r.isNeedPhy){var U=e.defined(c["POSITION"])?c["POSITION"].array:void 0,L=e.defined(c["_BATCHID"])?c["_BATCHID"].array:void 0,x=s,Y=d,k=l.CreatePhysicalArray.createPhysicalArrayFromModel(v,w,r.primitiveMode,U,L,x,Y);c["_PHYSICAL"]={array:k}}var z={indexArray:{typedArray:s,numberOfIndices:I},attributeData:c,min:A,max:m};return v.destroy(n),z}function M(r,t){return e.defined(r.dracoType)&&r.dracoType===O.PROJECTIVE_TRANSFORM?_(r,t):e.defined(r.primitive)?e.defined(r.dracoType)&&r.dracoType===O.MATER_COMPRESSION?g(r):F(r):G(r)}function V(e,r){p.EmWrapperManager.initWebAssembly(r).then((function(){v=p.emMod,w=new v.LBSpaMgr,N=e,self.onmessage=u(M),self.postMessage(!0)}))}function B(r){var t=r.data,a=t.webAssemblyConfig;if(e.defined(a))return require([a.modulePath],(function(r){e.defined(a.wasmBinaryFile)?(e.defined(r)||(r=self.DracoDecoderModule),r(a).then((function(e){V(e,a.wasmBinaryFileES6)}))):V(r(),a.wasmBinaryFileES6)}))}return B}));