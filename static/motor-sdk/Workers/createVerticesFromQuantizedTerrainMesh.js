define(["./when-52cea266","./Check-abb9b75f","./Cartesian2-7312ebeb","./Rectangle-9e59d921","./BoundingSphere-ff324c2c","./Transforms-f87238cb","./Matrix4-f7d115f5","./RuntimeError-02840484","./WebGLConstants-52779751","./ComponentDatatype-0d64f16b","./GeometryAttribute-55231797","./PrimitiveType-875d1f73","./AttributeCompression-8ffd5503","./IndexDatatype-d59649f4","./IntersectionTests-5644043d","./Plane-9b745adc","./WebMercatorProjection-2000cd98","./createTaskProcessorWorker","./AxisAlignedBoundingBox-dabc1f48","./EllipsoidTangentPlane-204e035e","./OrientedBoundingBox-2fac7a15","./EllipsoidRhumbLine-bfe2f143","./PolygonPipeline-c4c3c8f5","./CreatePhysicalArray-8ebb8367","./materem-62ee4902","./EmWrapperManager-0f203c26","./TerrainEncoding-86876cf6","./TerrainProvider-9f3c1c73","./EmLBDeal-e7aeb335"],(function(e,t,r,n,i,a,o,s,d,l,u,c,h,m,f,g,I,p,y,T,M,x,b,v,C,N,P,A,w){"use strict";var S,B=32767,E=new r.Cartesian3,F=new r.Cartesian3,V=new r.Cartesian3,L=new n.Cartographic,W=new r.Cartesian2,D=new r.Cartesian3,G=new o.Matrix4,k=new o.Matrix4;function z(t,s){var d=t.quantizedVertices,l=d.length/3;if(l<3)return{holeAllData:!0};var u,c=t.octEncodedNormals,f=t.westIndices.length+t.eastIndices.length+t.southIndices.length+t.northIndices.length-4,g=t.includeWebMercatorT,p=t.holeAry,T=t.planishBorderInfoAry,x=e.defined(p)&&p.length>0,b=e.defined(T)&&T.length>0,C=(t.tileInfo,t.needDownLoad),z=t.isNeedPhy,O=n.Rectangle.clone(t.rectangle),j=O.west,H=O.south,R=O.east,U=O.north,q=n.Ellipsoid.clone(t.ellipsoid),X=t.exaggeration,Z=t.minimumHeight*X,J=t.maximumHeight*X,K=t.relativeToCenter;u=t.isPlaneMode?o.Matrix4.fromTranslation(K):a.Transforms.eastNorthUpToFixedFrame(K,q);var Q,$,ee=o.Matrix4.inverseTransformation(u,new o.Matrix4);g&&(Q=I.WebMercatorProjection.geodeticLatitudeToMercatorAngle(H),$=1/(I.WebMercatorProjection.geodeticLatitudeToMercatorAngle(U)-Q));var te,re=d.subarray(0,l),ne=d.subarray(l,2*l),ie=d.subarray(2*l,3*l),ae=e.defined(c),oe=new Array(l),se=new Array(l),de=new Array(l),le=g?new Array(l):[];ae&&(te=[...c]);var ue=[...t.indices],ce=F;ce.x=Number.POSITIVE_INFINITY,ce.y=Number.POSITIVE_INFINITY,ce.z=Number.POSITIVE_INFINITY;var he=V;he.x=Number.NEGATIVE_INFINITY,he.y=Number.NEGATIVE_INFINITY,he.z=Number.NEGATIVE_INFINITY;var me,fe=Number.POSITIVE_INFINITY,ge=Number.NEGATIVE_INFINITY,Ie=Number.POSITIVE_INFINITY,pe=Number.NEGATIVE_INFINITY,ye=!1;if(t.isPlaneMode){var Te=t.projectionString,Me=t.dCenX,xe=t.dCenY,be=t.dCenZ;me=new w.EmLBDeal;var ve=me.init(Te,new r.Cartesian3(Me,xe,be));ve?b&&me.setPlanishBorderInfoAry(T):(me.destroy(),me=void 0),ye=t.isDefaultTer}for(var Ce=0;Ce<l;++Ce){var Ne=re[Ce],Pe=ne[Ce],Ae=Ne/B,we=Pe/B,Se=r.CesiumMath.lerp(Z,J,ie[Ce]/B);L.longitude=r.CesiumMath.lerp(j,R,Ae),L.latitude=r.CesiumMath.lerp(H,U,we),L.height=Se,fe=Math.min(L.longitude,fe),ge=Math.max(L.longitude,ge),Ie=Math.min(L.latitude,Ie),pe=Math.max(L.latitude,pe);var Be=q.cartographicToCartesian(L);e.defined(me)&&(Be=me.computeCartesianToProj(Be),ye&&(Be.z=0)),oe[Ce]=new r.Cartesian2(Ae,we),se[Ce]=Se,de[Ce]=Be,g&&(le[Ce]=(I.WebMercatorProjection.geodeticLatitudeToMercatorAngle(L.latitude)-Q)*$),o.Matrix4.multiplyByPoint(ee,Be,E),r.Cartesian3.minimumByComponent(E,ce,ce),r.Cartesian3.maximumByComponent(E,he,he)}var Ee=_(t.westIndices,(function(e,t){return oe[e].y-oe[t].y})),Fe=_(t.eastIndices,(function(e,t){return oe[t].y-oe[e].y})),Ve=_(t.southIndices,(function(e,t){return oe[t].x-oe[e].x})),Le=_(t.northIndices,(function(e,t){return oe[e].x-oe[t].x})),We=1e-4,De=(ge-fe)*We,Ge=(pe-Ie)*We,ke=-De,ze=0,Ye=De,_e=0,Oe=0,je=Ge,He=0,Re=-Ge,Ue=de.length,qe=Z,Xe=de.length;qe=Math.min(qe,Y(Ee,de,se,oe,te,le,q,O,t.westSkirtHeight,ke,ze,me));var Ze=de.length;qe=Math.min(qe,Y(Ve,de,se,oe,te,le,q,O,t.southSkirtHeight,He,Re,me));var Je=de.length;qe=Math.min(qe,Y(Fe,de,se,oe,te,le,q,O,t.eastSkirtHeight,Ye,_e,me));var Ke=de.length;qe=Math.min(qe,Y(Le,de,se,oe,te,le,q,O,t.northSkirtHeight,Oe,je,me));for(var Qe,$e,et,tt=ue.length,rt=3*Math.max(0,2*f),nt=0;nt<rt;nt++)ue.push(0);if(A.TerrainProvider.addSkirtIndices(Ee,Ve,Fe,Le,Xe,Ze,Je,Ke,ue,tt),1!==X&&($e=i.BoundingSphere.fromPoints(de),Qe=M.OrientedBoundingBox.fromRectangle(O,Z,J,q)),1!==X||Z<0){var it=new P.EllipsoidalOccluder(q);et=it.computeHorizonCullingPointPossiblyUnderEllipsoid(K,de,Z)}const at=[];var ot=(e,t)=>{let r=new N.emMod.LBSpaSerial;r.WriteTriangle(t);let n=new Uint8Array(r.GetBufferSize());for(let i=0;i<n.length;++i)n[i]=r.GetBufferVal(i);N.emMod.destroy(r),at.push({serial:n,fileName:e})},st=(e,t,r)=>{let n=0,i=new N.emMod.LBSpaTriangle;i.SetPtNum(e.length,!1,!1);for(let o=0;o<e.length;o++){const t=e[o];i.SetPtVal(o,t.x,t.y,t.z)}i.SetIndexNum(t.length);for(let o=0;o<t.length;o++)i.SetIndexVal(o,t[o]);C&&ot(r>0?"ter2.tri":"hole2.tri",i);let a=new N.emMod.LBSpaBody;return a.Init(i,n),N.emMod.destroy(i),a},dt=t=>{de.length=0,ue.length=0,oe.length=0,se.length=0,g&&(le.length=0),ae&&(te.length=0,ae=!1);let i=new N.emMod.LBSpaTriangle,a=new N.emMod.LBSpaSkirtInfo;t.GetTriangle(i,a);let o=i.GetPtNum(),s=i.GetIndexNum();if(o<3||s<3)return N.emMod.destroy(i),void N.emMod.destroy(a);Ue=a.iPtSectIndex,tt=a.iIndexSectIndex;for(let d=0;d<o;d++){let t=i.GetPt(d),a=new r.Cartesian3(t.x,t.y,t.z);de.push(a),e.defined(me)?(me.computeProjToDegree(a,!0,E),n.Cartographic.fromDegrees(E.x,E.y,E.z,L)):q.cartesianToCartographic(a,L);let o=new r.Cartesian2((L.longitude-j)/(R-j),(L.latitude-H)/(U-H));oe.push(o),se.push(L.height),g&&le.push((I.WebMercatorProjection.geodeticLatitudeToMercatorAngle(L.latitude)-Q)*$)}for(let e=0;e<s;e++)ue.push(i.GetIndex(e));N.emMod.destroy(i),N.emMod.destroy(a)},lt=()=>{let e,t=!1;const r=y.AxisAlignedBoundingBox.fromPoints(de);for(let n=0;n<p.length;n++){const i=w.BorderInfo.clone(p[n]);let a=[],o=[];i.createTriangle(a,o);const s=y.AxisAlignedBoundingBox.fromPoints(a);if(!r.isOverlap(s))continue;void 0===e&&(e=st(de,ue,tt));let d=st(a,o);e.CheckReference(d)?e.ComputeDifference(d)?(N.emMod.destroy(d),t=!0):N.emMod.destroy(d):N.emMod.destroy(d)}return t&&dt(e),void 0!==e&&N.emMod.destroy(e),t};let ut=!1;if(x&&(ut=lt(),de.length<3))return{holeAllData:!0};for(var ct=new y.AxisAlignedBoundingBox(ce,he,K),ht=new P.TerrainEncoding(ct,qe,J,u,ae,g),mt=ht.getStride(),ft=de.length*mt,gt=new Float32Array(ft),It=0,pt=0;pt<de.length;++pt){if(ae){var yt=2*pt;if(W.x=te[yt],W.y=te[yt+1],1!==X){var Tt=h.AttributeCompression.octDecode(W.x,W.y,D),Mt=a.Transforms.eastNorthUpToFixedFrame(de[pt],q,k),xt=o.Matrix4.inverseTransformation(Mt,G);o.Matrix4.multiplyByPointAsVector(xt,Tt,Tt),Tt.z*=X,r.Cartesian3.normalize(Tt,Tt),o.Matrix4.multiplyByPointAsVector(Mt,Tt,Tt),r.Cartesian3.normalize(Tt,Tt),h.AttributeCompression.octEncode(Tt,W)}}It=ht.encode(gt,It,de[pt],oe[pt],se[pt],W,le[pt])}var bt,vt=m.IndexDatatype.createTypedArray(de.length,ue.length);return vt.set(ue,0),z?(bt=v.CreatePhysicalArray.createPhysicalArrayFromTerrain(N.emMod,S,t.relativeToCenter,de,ue),s.push(gt.buffer,vt.buffer,bt.buffer)):s.push(gt.buffer,vt.buffer),e.defined(me)&&me.destroy(),{vertices:gt.buffer,indices:vt.buffer,vertexStride:mt,center:K,minimumHeight:Z,maximumHeight:J,boundingSphere:$e,orientedBoundingBox:Qe,occludeePointInScaledSpace:et,encoding:ht,indexCountWithoutSkirts:tt,vertexCountWithoutSkirts:Ue,vertexCount:de.length,physicalArray:bt,downloadAry:at,haveDiff:ut}}function Y(t,n,i,a,o,s,d,l,u,c,h,m){var f=e.defined(o),g=s.length>0,I=Number.POSITIVE_INFINITY,p=l.north,y=l.south,T=l.east,M=l.west;T<M&&(T+=r.CesiumMath.TWO_PI);for(var x=t.length-1,b=0;b<x;++b){var v=t[b],C=i[v],N=a[v];L.longitude=r.CesiumMath.lerp(M,T,N.x)+c,L.latitude=r.CesiumMath.lerp(y,p,N.y)+h,L.height=C-u;var P=d.cartographicToCartesian(L,E);if(e.defined(m)&&(P=m.computeCartesianToProj(P)),n.push(P),a.push(N),i.push(L.height),f){var A=2*v;o.push(o[A]),o.push(o[A+1])}if(g){var w=s[v];s.push(w)}I=Math.min(I,L.height)}return I}function _(t,r){var n;return"function"===typeof t.slice&&(n=t.slice(),"function"!==typeof n.sort&&(n=void 0)),e.defined(n)||(n=Array.prototype.slice.call(t)),n.sort(r),n}function O(t){var r=t.data,n=r.webAssemblyConfig;e.defined(n)&&N.EmWrapperManager.initWebAssembly(n.wasmBinaryFileES6).then((function(){S=new N.emMod.LBSpaMgr,self.onmessage=p(z),self.postMessage(!0)}))}return O}));